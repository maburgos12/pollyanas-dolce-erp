{% extends "base.html" %}
{% block title %}Compras - Órdenes{% endblock %}
{% block page_title %}Compras · Órdenes{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'compras:solicitudes' %}">Solicitudes</a>
  <a class="module-tab active" href="{% url 'compras:ordenes' %}">Órdenes</a>
  <a class="module-tab" href="{% url 'compras:recepciones' %}">Recepciones</a>
</nav>

<section class="card">
  <div class="card-header">Nueva Orden de Compra</div>
  {% if can_manage_compras %}
  <form method="post" class="form-grid-auto">
    {% csrf_token %}
    <select class="input-field" name="solicitud_id" required>
      <option value="">Solicitud aprobada</option>
      {% for s in solicitudes %}<option value="{{ s.id }}">{{ s.folio }} - {{ s.insumo.nombre }}</option>{% endfor %}
    </select>
    <select class="input-field" name="proveedor_id" required>
      <option value="">Proveedor</option>
      {% for p in proveedores %}<option value="{{ p.id }}">{{ p.nombre }}</option>{% endfor %}
    </select>
    <input class="input-field" type="date" name="fecha_emision" required>
    <input class="input-field" type="date" name="fecha_entrega_estimada">
    <input class="input-field" type="number" min="0" step="0.01" name="monto_estimado" placeholder="Monto estimado">
    <select class="input-field" name="estatus">
      {% for value, label in status_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Guardar orden</button>
  </form>
  {% else %}
  <p class="muted">Tu perfil está en modo lectura para Compras.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Órdenes Registradas</div>
  <form method="get" class="form-grid-auto mb-3">
    <select class="input-field" name="proveedor_id">
      <option value="">Todos los proveedores</option>
      {% for p in proveedores %}
      <option value="{{ p.id }}" {% if proveedor_filter == p.id|stringformat:"s" %}selected{% endif %}>{{ p.nombre }}</option>
      {% endfor %}
    </select>
    <select class="input-field" name="estatus">
      <option value="all" {% if estatus_filter == "ALL" %}selected{% endif %}>Todos los estatus</option>
      {% for value, label in status_choices %}
      <option value="{{ value }}" {% if estatus_filter == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <input class="input-field" type="month" name="mes" value="{{ mes_filter }}">
    <input class="input-field" type="text" name="q" value="{{ q_filter }}" placeholder="Buscar folio/referencia/proveedor...">
    <button class="btn btn-primary" type="submit">Aplicar filtros</button>
    <a class="btn btn-secondary" href="{% url 'compras:ordenes' %}">Limpiar</a>
  </form>
  <div class="toolbar mb-3">
    <a class="btn btn-secondary" href="?{% if current_query %}{{ current_query }}&{% endif %}export=csv">Exportar CSV</a>
    <a class="btn btn-secondary" href="?{% if current_query %}{{ current_query }}&{% endif %}export=xlsx">Exportar XLSX</a>
  </div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>OC</th>
          <th>Solicitud</th>
          <th>Referencia</th>
          <th>Proveedor</th>
          <th>Emisión</th>
          <th>Entrega estimada</th>
          <th class="text-end">Monto</th>
          <th>Estatus</th>
          {% if can_manage_compras %}<th>Flujo</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for o in ordenes %}
        <tr>
          <td>{{ o.folio }}</td>
          <td>{% if o.solicitud %}{{ o.solicitud.folio }}{% else %}-{% endif %}</td>
          <td>{{ o.referencia|default:"-" }}</td>
          <td>{{ o.proveedor.nombre }}</td>
          <td>{{ o.fecha_emision }}</td>
          <td>{{ o.fecha_entrega_estimada|default:"-" }}</td>
          <td class="text-end">${{ o.monto_estimado|floatformat:2 }}</td>
          <td>
            {% if o.estatus == 'CERRADA' or o.estatus == 'CONFIRMADA' %}
              <span class="badge bg-success">{{ o.get_estatus_display }}</span>
            {% elif o.estatus == 'PARCIAL' %}
              <span class="badge bg-warning">{{ o.get_estatus_display }}</span>
            {% else %}
              <span class="badge bg-primary">{{ o.get_estatus_display }}</span>
            {% endif %}
          </td>
          {% if can_manage_compras %}
          <td>
            <div class="recipe-actions">
            {% if o.estatus == 'BORRADOR' %}
              <form method="post" action="{% url 'compras:orden_estatus' o.id 'ENVIADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-secondary" type="submit">Enviar</button></form>
            {% endif %}
            {% if o.estatus == 'ENVIADA' %}
              <form method="post" action="{% url 'compras:orden_estatus' o.id 'CONFIRMADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-success" type="submit">Confirmar</button></form>
              <form method="post" action="{% url 'compras:orden_estatus' o.id 'PARCIAL' %}" class="inline-form">{% csrf_token %}<button class="btn btn-secondary" type="submit">Parcial</button></form>
            {% endif %}
            {% if o.estatus == 'CONFIRMADA' or o.estatus == 'PARCIAL' %}
              <form method="post" action="{% url 'compras:orden_estatus' o.id 'CERRADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-primary" type="submit">Cerrar</button></form>
            {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if can_manage_compras %}10{% else %}9{% endif %}" class="text-muted">Sin órdenes registradas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
