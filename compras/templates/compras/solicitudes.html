{% extends "base.html" %}
{% block title %}Compras - Solicitudes{% endblock %}
{% block page_title %}Compras · Solicitudes{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab active" href="{% url 'compras:solicitudes' %}">Solicitudes</a>
  <a class="module-tab" href="{% url 'compras:ordenes' %}">Órdenes</a>
  <a class="module-tab" href="{% url 'compras:recepciones' %}">Recepciones</a>
</nav>

<section class="card">
  <div class="card-header">Nueva Solicitud</div>
  {% if can_manage_compras %}
  <form method="post" class="form-grid-auto">
    {% csrf_token %}
    <input class="input-field" name="area" placeholder="Área" required>
    <input class="input-field" name="solicitante" placeholder="Solicitante" required>
    <select class="input-field" id="insumo_id" name="insumo_id" required>
      <option value="">Insumo</option>
      {% for i in insumo_options %}
      <option
        value="{{ i.id }}"
        data-stock="{{ i.stock_actual }}"
        data-reorden="{{ i.punto_reorden }}"
        data-recomendado="{{ i.recomendado }}"
        data-proveedor="{{ i.proveedor_sugerido }}"
      >
        {{ i.nombre }}
      </option>
      {% endfor %}
    </select>
    <input class="input-field" id="cantidad" type="number" step="0.001" min="0" name="cantidad" placeholder="Cantidad" required>
    <input class="input-field" type="date" name="fecha_requerida" required>
    <select class="input-field" name="estatus">
      {% for value, label in status_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Guardar solicitud</button>
  </form>
  <p id="stock-hint" class="muted mb-0">Selecciona un insumo para ver stock, punto de reorden, sugerencia y proveedor principal.</p>

  <hr style="margin: 18px 0;">
  <div class="card-header" style="padding:0 0 12px 0;border:0;">Carga Masiva de Solicitudes (XLSX/CSV)</div>
  <div class="toolbar" style="margin-bottom: 8px;">
    <a class="btn btn-secondary" href="{% url 'compras:solicitudes_importar_plantilla' %}?format=xlsx">Descargar plantilla XLSX</a>
    <a class="btn btn-secondary" href="{% url 'compras:solicitudes_importar_plantilla' %}?format=csv">Descargar plantilla CSV</a>
  </div>
  <form method="post" action="{% url 'compras:solicitudes_importar' %}" enctype="multipart/form-data" class="form-grid-auto">
    {% csrf_token %}
    <input class="input-field" type="file" name="archivo" accept=".xlsx,.xlsm,.csv" required>
    <select class="input-field" name="periodo_tipo">
      <option value="mes">Mensual</option>
      <option value="q1">1ra quincena</option>
      <option value="q2">2da quincena</option>
      <option value="all">Sin periodo (hoy)</option>
    </select>
    <input class="input-field" type="month" name="periodo_mes" value="{{ periodo_mes }}">
    <input class="input-field" name="area" placeholder="Área por default (ej. Compras)" value="Compras">
    <input class="input-field" name="solicitante" placeholder="Solicitante por default" value="{{ request.user.username }}">
    <select class="input-field" name="estatus">
      {% for value, label in status_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <input class="input-field" type="number" name="score_min" min="0" max="100" step="1" value="90" placeholder="Score mínimo match">
    <label class="inline-check">
      <input type="checkbox" name="evitar_duplicados" checked>
      Evitar duplicados (área + insumo + fecha)
    </label>
    <button class="btn btn-secondary" type="submit">Previsualizar solicitudes</button>
  </form>
  <p class="muted mb-0">Columnas sugeridas del archivo: <code>insumo</code>, <code>cantidad</code>, <code>proveedor</code>, <code>fecha_requerida</code>, <code>area</code>, <code>solicitante</code>.</p>
  {% if import_preview %}
  <section class="card" style="margin-top: 14px;">
    <div class="card-header" style="padding:0 0 10px 0;border:0;">Vista previa de importación</div>
    <p class="muted">Filas: <strong>{{ import_preview.count }}</strong>. Puedes editar celdas, desmarcar filas para eliminarlas de la carga y luego confirmar.</p>
    <div class="kpi-grid kpi-mini" style="margin-bottom: 8px;">
      <article class="kpi-card">
        <div class="kpi-number is-success" id="preview-ready-count">{{ import_preview.ready_count }}</div>
        <div class="kpi-label">Marcadas para importar</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-number is-warning">{{ import_preview.excluded_count }}</div>
        <div class="kpi-label">Desmarcadas</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-number {% if import_preview.issues_count > 0 %}is-danger{% else %}is-success{% endif %}">{{ import_preview.issues_count }}</div>
        <div class="kpi-label">Filas con observaciones</div>
      </article>
      <article class="kpi-card">
        <div class="kpi-number {% if import_preview.without_match_count > 0 %}is-danger{% else %}is-success{% endif %}">{{ import_preview.without_match_count }}</div>
        <div class="kpi-label">Sin insumo asignado</div>
      </article>
    </div>
    <form method="post" action="{% url 'compras:solicitudes_importar_confirmar' %}">
      {% csrf_token %}
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>
                <label class="inline-check">
                  <input id="import-preview-check-all" type="checkbox" checked>
                  Importar
                </label>
              </th>
              <th>Fila</th>
              <th>Insumo (archivo)</th>
              <th>Insumo final</th>
              <th class="text-end">Cantidad</th>
              <th>Fecha</th>
              <th>Área</th>
              <th>Solicitante</th>
              <th>Proveedor</th>
              <th>Estatus</th>
              <th>Validación</th>
            </tr>
          </thead>
          <tbody>
            {% for row in import_preview.rows %}
            <tr>
              <td><input class="import-preview-row-check" type="checkbox" name="row_{{ row.row_id }}_include" {% if row.include %}checked{% endif %}></td>
              <td>{{ row.source_row }}</td>
              <td>
                {{ row.insumo_origen|default:"-" }}
                {% if row.insumo_sugerencia %}
                <div class="muted">Sugerencia: {{ row.insumo_sugerencia }} (score {{ row.score }} · {{ row.metodo }})</div>
                {% endif %}
              </td>
              <td>
                <select class="input-field" name="row_{{ row.row_id }}_insumo_id">
                  <option value="">Selecciona insumo...</option>
                  {% for i in insumo_options %}
                  <option value="{{ i.id }}" {% if row.insumo_id == i.id|stringformat:'s' %}selected{% endif %}>{{ i.nombre }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <input class="input-field text-end" type="number" step="0.001" min="0" name="row_{{ row.row_id }}_cantidad" value="{{ row.cantidad }}">
              </td>
              <td>
                <input class="input-field" type="date" name="row_{{ row.row_id }}_fecha_requerida" value="{{ row.fecha_requerida }}">
              </td>
              <td>
                <input class="input-field" type="text" name="row_{{ row.row_id }}_area" value="{{ row.area }}">
              </td>
              <td>
                <input class="input-field" type="text" name="row_{{ row.row_id }}_solicitante" value="{{ row.solicitante }}">
              </td>
              <td>
                <select class="input-field" name="row_{{ row.row_id }}_proveedor_id">
                  <option value="">Proveedor principal del insumo</option>
                  {% for p in proveedor_options %}
                  <option value="{{ p.id }}" {% if row.proveedor_id == p.id|stringformat:'s' %}selected{% endif %}>{{ p.nombre }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select class="input-field" name="row_{{ row.row_id }}_estatus">
                  {% for value, label in status_choices %}
                  <option value="{{ value }}" {% if row.estatus == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                {% if row.notes %}
                <span class="badge-amarillo">{{ row.notes }}</span>
                {% else %}
                <span class="badge-verde">Lista</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="toolbar" style="margin-top: 10px;">
        <button class="btn btn-primary" type="submit">Confirmar importación</button>
      </div>
    </form>
    <form method="post" action="{% url 'compras:solicitudes_importar_cancelar' %}" style="margin-top: 10px;">
      {% csrf_token %}
      <button class="btn btn-secondary" type="submit">Cancelar vista previa</button>
    </form>
  </section>
  {% endif %}
  {% else %}
  <p class="muted">Tu perfil está en modo lectura para Compras.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Solicitudes Registradas</div>
  <form method="get" class="form-grid-auto mb-3">
    <div>
      <label for="source">Origen</label>
      <select id="source" name="source" class="input-field">
        <option value="all" {% if source_filter == 'all' %}selected{% endif %}>Todos</option>
        <option value="manual" {% if source_filter == 'manual' %}selected{% endif %}>Manual</option>
        <option value="plan" {% if source_filter == 'plan' %}selected{% endif %}>Desde plan</option>
      </select>
    </div>
    <div>
      <label for="plan_id">Plan específico (opcional)</label>
      <select id="plan_id" name="plan_id" class="input-field">
        <option value="">Todos los planes</option>
        {% for p in plan_options %}
        <option value="{{ p.id }}" {% if plan_filter == p.id|stringformat:'s' %}selected{% endif %}>#{{ p.id }} · {{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="categoria">Categoría</label>
      <select id="categoria" name="categoria" class="input-field">
        <option value="">Todas</option>
        {% for c in categoria_options %}
        <option value="{{ c }}" {% if categoria_filter == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="reabasto">Reabasto</label>
      <select id="reabasto" name="reabasto" class="input-field">
        <option value="all" {% if reabasto_filter == 'all' %}selected{% endif %}>Todos</option>
        <option value="critico" {% if reabasto_filter == 'critico' %}selected{% endif %}>Críticos</option>
        <option value="bajo" {% if reabasto_filter == 'bajo' %}selected{% endif %}>Bajo reorden</option>
        <option value="ok" {% if reabasto_filter == 'ok' %}selected{% endif %}>Suficiente</option>
      </select>
    </div>
    <div>
      <label for="periodo_tipo">Periodo</label>
      <select id="periodo_tipo" name="periodo_tipo" class="input-field">
        <option value="all" {% if periodo_tipo == 'all' %}selected{% endif %}>Todos</option>
        <option value="mes" {% if periodo_tipo == 'mes' %}selected{% endif %}>Mensual</option>
        <option value="q1" {% if periodo_tipo == 'q1' %}selected{% endif %}>1ra quincena</option>
        <option value="q2" {% if periodo_tipo == 'q2' %}selected{% endif %}>2da quincena</option>
      </select>
    </div>
    <div>
      <label for="periodo_mes">Mes</label>
      <input id="periodo_mes" class="input-field" type="month" name="periodo_mes" value="{{ periodo_mes }}">
    </div>
    <div>
      <label for="consumo_ref">Consumo real</label>
      <select id="consumo_ref" name="consumo_ref" class="input-field">
        <option value="all" {% if consumo_ref_filter == 'all' %}selected{% endif %}>Todos los movimientos</option>
        <option value="plan_ref" {% if consumo_ref_filter == 'plan_ref' %}selected{% endif %}>Solo con referencia de plan</option>
      </select>
    </div>
    <div class="align-items-end d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar filtros</button>
      <a href="{% url 'compras:solicitudes' %}" class="btn btn-secondary">Limpiar</a>
    </div>
  </form>
  <p class="muted">
    Periodo activo: <strong>{{ periodo_label }}</strong>
    {% if categoria_filter %} · Categoría: <strong>{{ categoria_filter }}</strong>{% endif %}
    · Consumo: <strong>{% if consumo_ref_filter == 'plan_ref' %}Solo referencia plan{% else %}Todos{% endif %}</strong>
  </p>
  <section class="card" style="margin: 12px 0;">
    <div class="card-header">Presupuesto y Desviación (Periodo)</div>
    {% if periodo_tipo == 'all' %}
      <p class="muted mb-0">Selecciona un periodo mensual o quincenal para habilitar objetivo de presupuesto y variación.</p>
    {% else %}
      {% if can_manage_compras %}
      <form method="post" action="{% url 'compras:solicitudes_presupuesto' %}" class="form-grid-auto mb-3">
        {% csrf_token %}
        <input type="hidden" name="source" value="{{ source_filter }}">
        <input type="hidden" name="plan_id" value="{{ plan_filter }}">
        <input type="hidden" name="categoria" value="{{ categoria_filter }}">
        <input type="hidden" name="reabasto" value="{{ reabasto_filter }}">
        <input type="hidden" name="periodo_tipo" value="{{ periodo_tipo }}">
        <input type="hidden" name="periodo_mes" value="{{ periodo_mes }}">
        <input type="hidden" name="consumo_ref" value="{{ consumo_ref_filter }}">
        <div>
          <label>Monto objetivo</label>
          <input class="input-field" type="number" name="monto_objetivo" min="0" step="0.01" value="{{ presupuesto_objetivo|default_if_none:0|floatformat:2 }}">
        </div>
        <div>
          <label>Notas</label>
          <input class="input-field" type="text" name="notas" maxlength="255" value="{{ presupuesto_periodo.notas|default:'' }}" placeholder="Opcional">
        </div>
        <div class="align-items-end d-flex">
          <button class="btn btn-primary" type="submit">Guardar presupuesto</button>
        </div>
      </form>
      <form method="post" action="{% url 'compras:solicitudes_presupuesto_proveedor' %}" class="form-grid-auto mb-3">
        {% csrf_token %}
        <input type="hidden" name="source" value="{{ source_filter }}">
        <input type="hidden" name="plan_id" value="{{ plan_filter }}">
        <input type="hidden" name="categoria" value="{{ categoria_filter }}">
        <input type="hidden" name="reabasto" value="{{ reabasto_filter }}">
        <input type="hidden" name="periodo_tipo" value="{{ periodo_tipo }}">
        <input type="hidden" name="periodo_mes" value="{{ periodo_mes }}">
        <input type="hidden" name="consumo_ref" value="{{ consumo_ref_filter }}">
        <div>
          <label>Proveedor</label>
          <select class="input-field" name="proveedor_id" required>
            <option value="">Selecciona proveedor...</option>
            {% for p in proveedor_options %}
              <option value="{{ p.id }}">{{ p.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Objetivo proveedor</label>
          <input class="input-field" type="number" name="monto_objetivo_proveedor" min="0" step="0.01" required>
        </div>
        <div>
          <label>Notas proveedor</label>
          <input class="input-field" type="text" name="notas_proveedor" maxlength="255" placeholder="Opcional">
        </div>
        <div class="align-items-end d-flex">
          <button class="btn btn-secondary" type="submit">Guardar objetivo proveedor</button>
        </div>
      </form>
      <form method="post" action="{% url 'compras:solicitudes_presupuesto_categoria' %}" class="form-grid-auto mb-3">
        {% csrf_token %}
        <input type="hidden" name="source" value="{{ source_filter }}">
        <input type="hidden" name="plan_id" value="{{ plan_filter }}">
        <input type="hidden" name="categoria" value="{{ categoria_filter }}">
        <input type="hidden" name="reabasto" value="{{ reabasto_filter }}">
        <input type="hidden" name="periodo_tipo" value="{{ periodo_tipo }}">
        <input type="hidden" name="periodo_mes" value="{{ periodo_mes }}">
        <input type="hidden" name="consumo_ref" value="{{ consumo_ref_filter }}">
        <div>
          <label>Categoría</label>
          <input class="input-field" type="text" name="categoria" list="categoria_options" placeholder="Ej. Lácteos, Harinas, Empaque..." required>
          <datalist id="categoria_options">
            {% for c in categoria_options %}
              <option value="{{ c }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div>
          <label>Objetivo categoría</label>
          <input class="input-field" type="number" name="monto_objetivo_categoria" min="0" step="0.01" required>
        </div>
        <div>
          <label>Notas categoría</label>
          <input class="input-field" type="text" name="notas_categoria" maxlength="255" placeholder="Opcional">
        </div>
        <div class="align-items-end d-flex">
          <button class="btn btn-secondary" type="submit">Guardar objetivo categoría</button>
        </div>
      </form>
      <form method="post" action="{% url 'compras:solicitudes_presupuesto_importar' %}" enctype="multipart/form-data" class="form-grid-auto mb-3">
        {% csrf_token %}
        <input type="hidden" name="source" value="{{ source_filter }}">
        <input type="hidden" name="plan_id" value="{{ plan_filter }}">
        <input type="hidden" name="categoria" value="{{ categoria_filter }}">
        <input type="hidden" name="reabasto" value="{{ reabasto_filter }}">
        <input type="hidden" name="periodo_tipo" value="{{ periodo_tipo }}">
        <input type="hidden" name="periodo_mes" value="{{ periodo_mes }}">
        <div>
          <label>Importar presupuesto (archivo)</label>
          <input class="input-field" type="file" name="archivo_presupuesto" accept=".xlsx,.xlsm,.csv" required>
        </div>
        <div class="align-items-end d-flex">
          <button class="btn btn-secondary" type="submit">Importar presupuesto</button>
        </div>
      </form>
      <p class="muted mb-3">
        Archivo esperado:
        <code>periodo_tipo</code> (mes/q1/q2),
        <code>periodo_mes</code> (YYYY-MM),
        <code>monto_objetivo</code> (objetivo periodo),
        <code>proveedor</code> (opcional),
        <code>monto_objetivo_proveedor</code> (opcional),
        <code>categoria</code> (opcional),
        <code>monto_objetivo_categoria</code> (opcional),
        <code>notas</code> (opcional).
      </p>
      {% endif %}
      <div class="kpi-mini">
        <article class="kpi-card">
          <div class="kpi-number">{{ presupuesto_objetivo|default_if_none:0|floatformat:2 }}</div>
          <div class="kpi-label">Objetivo presupuesto</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number is-warning">{{ presupuesto_estimado_total|floatformat:2 }}</div>
          <div class="kpi-label">Estimado solicitudes</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number {% if presupuesto_variacion_objetivo and presupuesto_variacion_objetivo > 0 %}is-danger{% else %}is-success{% endif %}">{{ presupuesto_variacion_objetivo|default_if_none:0|floatformat:2 }}</div>
          <div class="kpi-label">
            Variación vs objetivo
            {% if presupuesto_variacion_objetivo_pct is not None %}
              ({{ presupuesto_variacion_objetivo_pct|floatformat:2 }}%)
            {% endif %}
          </div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number is-success">{{ presupuesto_ejecutado_total|floatformat:2 }}</div>
          <div class="kpi-label">
            Ejecutado OC
            {% if presupuesto_avance_objetivo_pct is not None %}
              ({{ presupuesto_avance_objetivo_pct|floatformat:2 }}% objetivo)
            {% endif %}
          </div>
        </article>
      </div>
      <div class="kpi-mini">
        <article class="kpi-card">
          <div class="kpi-number {% if presupuesto_alertas_total > 0 %}is-danger{% else %}is-success{% endif %}">{{ presupuesto_alertas_total }}</div>
          <div class="kpi-label">Alertas presupuesto</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number is-danger">{{ presupuesto_alertas_excedidas|default:0 }}</div>
          <div class="kpi-label">Excedidas</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number is-warning">{{ presupuesto_alertas_preventivas|default:0 }}</div>
          <div class="kpi-label">Preventivas (>=90%)</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number">{{ presupuesto_objetivos_proveedor_total|default:0 }}</div>
          <div class="kpi-label">Objetivos por proveedor</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-number">{{ presupuesto_objetivos_categoria_total|default:0 }}</div>
          <div class="kpi-label">Objetivos por categoría</div>
        </article>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Nivel</th>
              <th>Alerta</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for a in presupuesto_alertas %}
              <tr>
                <td>
                  {% if a.nivel == 'alto' %}
                    <span class="badge-rojo">ALTA</span>
                  {% else %}
                    <span class="badge-amarillo">MEDIA</span>
                  {% endif %}
                </td>
                <td>{{ a.titulo }}</td>
                <td>{{ a.detalle }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-muted">Sin alertas de presupuesto para este periodo/filtro.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Categoría</th>
              <th class="text-end">Estimado</th>
              <th class="text-end">Ejecutado</th>
              <th class="text-end">Variación</th>
              <th class="text-end">% participación estimado</th>
              <th class="text-end">Objetivo categoría</th>
              <th class="text-end">% uso objetivo</th>
            </tr>
          </thead>
          <tbody>
            {% for r in presupuesto_rows_categoria %}
              <tr>
                <td>{{ r.categoria }}</td>
                <td class="text-end">${{ r.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ r.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion > 0 %}text-danger{% elif r.variacion < 0 %}text-success{% endif %}">${{ r.variacion|floatformat:2 }}</td>
                <td class="text-end">{{ r.participacion_pct|floatformat:2 }}%</td>
                <td class="text-end">${{ r.objetivo_categoria|floatformat:2 }}</td>
                <td class="text-end">
                  {% if r.uso_objetivo_pct is not None %}
                    {% if r.objetivo_estado == 'excedido' %}
                      <span class="badge-rojo">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% elif r.objetivo_estado == 'preventivo' %}
                      <span class="badge-amarillo">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% else %}
                      <span class="badge-verde">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-muted">Sin datos por categoría para este filtro.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th class="text-end">Estimado</th>
              <th class="text-end">Ejecutado</th>
              <th class="text-end">Variación</th>
              <th class="text-end">% participación estimado</th>
              <th class="text-end">Objetivo proveedor</th>
              <th class="text-end">% uso objetivo</th>
            </tr>
          </thead>
          <tbody>
            {% for r in presupuesto_rows_proveedor %}
              <tr>
                <td>{{ r.proveedor }}</td>
                <td class="text-end">${{ r.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ r.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion > 0 %}text-danger{% elif r.variacion < 0 %}text-success{% endif %}">${{ r.variacion|floatformat:2 }}</td>
                <td class="text-end">{{ r.participacion_pct|floatformat:2 }}%</td>
                <td class="text-end">${{ r.objetivo_proveedor|floatformat:2 }}</td>
                <td class="text-end">
                  {% if r.uso_objetivo_pct is not None %}
                    {% if r.objetivo_estado == 'excedido' %}
                      <span class="badge-rojo">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% elif r.objetivo_estado == 'preventivo' %}
                      <span class="badge-amarillo">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% else %}
                      <span class="badge-verde">{{ r.uso_objetivo_pct|floatformat:2 }}%</span>
                    {% endif %}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-muted">Sin datos por proveedor para este filtro.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card" style="margin-top: 12px;">
        <div class="card-header">Histórico Mensual (Últimos 6 meses)</div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Mes</th>
                <th>Semáforo</th>
                <th class="text-end">Objetivo</th>
                <th class="text-end">Estimado</th>
                <th class="text-end">Ejecutado</th>
                <th class="text-end">% Uso presupuesto</th>
              </tr>
            </thead>
            <tbody>
              {% for h in presupuesto_historial %}
                <tr>
                  <td>{{ h.periodo_mes }}</td>
                  <td><span class="badge {{ h.estado_badge }}">{{ h.estado_label }}</span></td>
                  <td class="text-end">${{ h.objetivo|floatformat:2 }}</td>
                  <td class="text-end">${{ h.estimado|floatformat:2 }}</td>
                  <td class="text-end">${{ h.ejecutado|floatformat:2 }}</td>
                  <td class="text-end">
                    {% if h.ratio_pct is not None %}
                      {{ h.ratio_pct|floatformat:2 }}%
                    {% else %}
                      -
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="6" class="text-muted">Sin histórico disponible.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top: 12px;">
        <div class="card-header">Tablero Proveedor (Top desviaciones + Tendencia)</div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Proveedor</th>
                <th class="text-end">Estimado</th>
                <th class="text-end">Ejecutado</th>
                <th class="text-end">Variación</th>
                <th class="text-end">Participación %</th>
                <th class="text-end">Objetivo</th>
                <th class="text-end">% Uso</th>
              </tr>
            </thead>
            <tbody>
              {% for r in provider_dashboard.top_desviaciones %}
              <tr>
                <td>{{ r.proveedor }}</td>
                <td class="text-end">${{ r.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ r.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion > 0 %}text-danger{% elif r.variacion < 0 %}text-success{% endif %}">${{ r.variacion|floatformat:2 }}</td>
                <td class="text-end">{{ r.participacion_pct|floatformat:2 }}%</td>
                <td class="text-end">${{ r.objetivo_proveedor|floatformat:2 }}</td>
                <td class="text-end">
                  {% if r.uso_objetivo_pct is not None %}
                    {{ r.uso_objetivo_pct|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-muted">Sin desviaciones para el periodo/filtro actual.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="table-responsive" style="margin-top: 10px;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Proveedor</th>
                <th>Mes</th>
                <th class="text-end">Estimado</th>
                <th class="text-end">Ejecutado</th>
                <th class="text-end">Variación</th>
              </tr>
            </thead>
            <tbody>
              {% for t in provider_dashboard.trend_rows %}
              <tr>
                <td>{{ t.proveedor }}</td>
                <td>{{ t.mes }}</td>
                <td class="text-end">${{ t.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ t.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if t.variacion > 0 %}text-danger{% elif t.variacion < 0 %}text-success{% endif %}">${{ t.variacion|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-muted">Sin datos de tendencia para proveedores.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top: 12px;">
        <div class="card-header">Tablero Categoría (Top desviaciones + Tendencia)</div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Categoría</th>
                <th class="text-end">Estimado</th>
                <th class="text-end">Ejecutado</th>
                <th class="text-end">Variación</th>
                <th class="text-end">Participación %</th>
                <th class="text-end">Objetivo</th>
                <th class="text-end">% Uso</th>
              </tr>
            </thead>
            <tbody>
              {% for r in category_dashboard.top_desviaciones %}
              <tr>
                <td>{{ r.categoria }}</td>
                <td class="text-end">${{ r.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ r.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion > 0 %}text-danger{% elif r.variacion < 0 %}text-success{% endif %}">${{ r.variacion|floatformat:2 }}</td>
                <td class="text-end">{{ r.participacion_pct|floatformat:2 }}%</td>
                <td class="text-end">${{ r.objetivo_categoria|floatformat:2 }}</td>
                <td class="text-end">
                  {% if r.uso_objetivo_pct is not None %}
                    {{ r.uso_objetivo_pct|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="7" class="text-muted">Sin desviaciones de categoría para el periodo/filtro actual.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="table-responsive" style="margin-top: 10px;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Categoría</th>
                <th>Mes</th>
                <th class="text-end">Estimado</th>
                <th class="text-end">Ejecutado</th>
                <th class="text-end">Variación</th>
              </tr>
            </thead>
            <tbody>
              {% for t in category_dashboard.trend_rows %}
              <tr>
                <td>{{ t.categoria }}</td>
                <td>{{ t.mes }}</td>
                <td class="text-end">${{ t.estimado|floatformat:2 }}</td>
                <td class="text-end">${{ t.ejecutado|floatformat:2 }}</td>
                <td class="text-end {% if t.variacion > 0 %}text-danger{% elif t.variacion < 0 %}text-success{% endif %}">${{ t.variacion|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-muted">Sin datos de tendencia para categorías.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
      <div class="card" style="margin-top: 12px;">
        <div class="card-header">Consumo Real vs Plan de Producción</div>
        <p class="muted">
          Rango evaluado: {{ consumo_dashboard.period_start }} a {{ consumo_dashboard.period_end }}.
          El costo se estima con el último costo unitario disponible por insumo.
        </p>
        <div class="kpi-mini">
          <article class="kpi-card">
            <div class="kpi-number">{{ consumo_dashboard.totals.plan_qty_total|floatformat:2 }}</div>
            <div class="kpi-label">Cantidad plan</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-number is-warning">{{ consumo_dashboard.totals.consumo_real_qty_total|floatformat:2 }}</div>
            <div class="kpi-label">Cantidad real consumida</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-number">{{ consumo_dashboard.totals.plan_cost_total|floatformat:2 }}</div>
            <div class="kpi-label">Costo plan</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-number is-success">{{ consumo_dashboard.totals.consumo_real_cost_total|floatformat:2 }}</div>
            <div class="kpi-label">Costo real</div>
          </article>
          <article class="kpi-card">
            <div class="kpi-number {% if consumo_dashboard.totals.variacion_cost_total > 0 %}is-danger{% elif consumo_dashboard.totals.variacion_cost_total < 0 %}is-success{% endif %}">
              {{ consumo_dashboard.totals.variacion_cost_total|floatformat:2 }}
            </div>
            <div class="kpi-label">
              Variación costo
              {% if consumo_dashboard.totals.cobertura_pct is not None %}
                ({{ consumo_dashboard.totals.cobertura_pct|floatformat:2 }}%)
              {% endif %}
            </div>
          </article>
          <article class="kpi-card">
            <div class="kpi-number {% if consumo_dashboard.totals.sin_costo_count > 0 %}is-danger{% else %}is-success{% endif %}">
              {{ consumo_dashboard.totals.sin_costo_count|default:0 }}
            </div>
            <div class="kpi-label">Insumos sin costo</div>
          </article>
        </div>
        <div class="table-responsive" style="margin-top:10px;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Insumo</th>
                <th>Categoría</th>
                <th>Unidad</th>
                <th class="text-end">Plan</th>
                <th class="text-end">Real</th>
                <th class="text-end">Variación qty</th>
                <th class="text-end">Costo unitario</th>
                <th class="text-end">Costo plan</th>
                <th class="text-end">Costo real</th>
                <th class="text-end">Variación costo</th>
                <th class="text-end">% Consumo</th>
                <th>Semáforo</th>
                <th>Alerta costo</th>
                <th>Estatus</th>
              </tr>
            </thead>
            <tbody>
              {% for r in consumo_dashboard.rows %}
              <tr>
                <td>{{ r.insumo }}</td>
                <td>{{ r.categoria }}</td>
                <td>{{ r.unidad }}</td>
                <td class="text-end">{{ r.cantidad_plan|floatformat:2 }}</td>
                <td class="text-end">{{ r.cantidad_real|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion_qty > 0 %}text-danger{% elif r.variacion_qty < 0 %}text-success{% endif %}">{{ r.variacion_qty|floatformat:2 }}</td>
                <td class="text-end">${{ r.costo_unitario|floatformat:2 }}</td>
                <td class="text-end">${{ r.costo_plan|floatformat:2 }}</td>
                <td class="text-end">${{ r.costo_real|floatformat:2 }}</td>
                <td class="text-end {% if r.variacion_cost > 0 %}text-danger{% elif r.variacion_cost < 0 %}text-success{% endif %}">${{ r.variacion_cost|floatformat:2 }}</td>
                <td class="text-end">
                  {% if r.consumo_pct is not None %}
                    {{ r.consumo_pct|floatformat:2 }}%
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if r.semaforo == 'ROJO' %}
                    <span class="badge-rojo">Rojo</span>
                  {% elif r.semaforo == 'AMARILLO' %}
                    <span class="badge-amarillo">Amarillo</span>
                  {% else %}
                    <span class="badge-verde">Verde</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.sin_costo %}
                    <span class="badge-rojo">Sin costo</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.estado == 'OK' %}
                    <span class="badge-verde">OK</span>
                  {% elif r.estado == 'SOBRECONSUMO' %}
                    <span class="badge-rojo">Sobreconsumo</span>
                  {% elif r.estado == 'BAJO_CONSUMO' %}
                    <span class="badge-amarillo">Bajo consumo</span>
                  {% elif r.estado == 'SIN_PLAN' %}
                    <span class="badge-amarillo">Sin plan</span>
                  {% else %}
                    <span class="badge-amarillo">Sin consumo</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="14" class="text-muted">Sin datos de consumo/plan para este rango.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
  </section>
  <div class="toolbar">
    <a href="{% url 'compras:solicitudes' %}?source={{ source_filter }}&plan_id={{ plan_filter }}&categoria={{ categoria_filter|urlencode }}&periodo_tipo={{ periodo_tipo }}&periodo_mes={{ periodo_mes }}&consumo_ref={{ consumo_ref_filter }}" class="btn {% if reabasto_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">Todos</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=critico&source={{ source_filter }}&plan_id={{ plan_filter }}&categoria={{ categoria_filter|urlencode }}&periodo_tipo={{ periodo_tipo }}&periodo_mes={{ periodo_mes }}&consumo_ref={{ consumo_ref_filter }}" class="btn {% if reabasto_filter == 'critico' %}btn-primary{% else %}btn-secondary{% endif %}">Críticos</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=bajo&source={{ source_filter }}&plan_id={{ plan_filter }}&categoria={{ categoria_filter|urlencode }}&periodo_tipo={{ periodo_tipo }}&periodo_mes={{ periodo_mes }}&consumo_ref={{ consumo_ref_filter }}" class="btn {% if reabasto_filter == 'bajo' %}btn-primary{% else %}btn-secondary{% endif %}">Bajo reorden</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=ok&source={{ source_filter }}&plan_id={{ plan_filter }}&categoria={{ categoria_filter|urlencode }}&periodo_tipo={{ periodo_tipo }}&periodo_mes={{ periodo_mes }}&consumo_ref={{ consumo_ref_filter }}" class="btn {% if reabasto_filter == 'ok' %}btn-primary{% else %}btn-secondary{% endif %}">Suficiente</a>
    <a href="{% url 'compras:solicitudes_print' %}{% if current_query %}?{{ current_query }}{% endif %}" target="_blank" class="btn btn-secondary">Imprimir solicitud compras</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=csv{% else %}?export=csv{% endif %}" class="btn btn-secondary">Exportar CSV</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=xlsx{% else %}?export=xlsx{% endif %}" class="btn btn-secondary">Exportar XLSX</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=consolidado_csv{% else %}?export=consolidado_csv{% endif %}" class="btn btn-secondary">Export consolidado CSV</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=consolidado_xlsx{% else %}?export=consolidado_xlsx{% endif %}" class="btn btn-secondary">Export consolidado XLSX</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=proveedor_csv{% else %}?export=proveedor_csv{% endif %}" class="btn btn-secondary">Export tablero proveedor CSV</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=proveedor_xlsx{% else %}?export=proveedor_xlsx{% endif %}" class="btn btn-secondary">Export tablero proveedor XLSX</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=categoria_csv{% else %}?export=categoria_csv{% endif %}" class="btn btn-secondary">Export tablero categoría CSV</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=categoria_xlsx{% else %}?export=categoria_xlsx{% endif %}" class="btn btn-secondary">Export tablero categoría XLSX</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=consumo_plan_csv{% else %}?export=consumo_plan_csv{% endif %}" class="btn btn-secondary">Export consumo vs plan CSV</a>
    <a href="{% url 'compras:solicitudes' %}{% if current_query %}?{{ current_query }}&export=consumo_plan_xlsx{% else %}?export=consumo_plan_xlsx{% endif %}" class="btn btn-secondary">Export consumo vs plan XLSX</a>
  </div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Área</th>
          <th>Solicitante</th>
          <th>Origen</th>
          <th>Insumo</th>
          <th>Proveedor sugerido</th>
          <th>Reabasto</th>
          <th class="text-end">Cantidad</th>
          <th class="text-end">Costo unitario</th>
          <th class="text-end">Presupuesto</th>
          <th>Fecha requerida</th>
          <th>Estatus</th>
          {% if can_manage_compras %}<th>Flujo</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in solicitudes %}
        <tr>
          <td>{{ s.folio }}</td>
          <td>{{ s.area }}</td>
          <td>{{ s.solicitante }}</td>
          <td>
            {% if s.source_tipo == 'plan' %}
              <span class="badge-amarillo"><a href="{% url 'recetas:plan_produccion' %}?plan_id={{ s.source_plan_id }}" style="color: inherit; text-decoration: none;">Plan #{{ s.source_plan_id }}</a></span>
            {% else %}
              <span class="badge-verde">Manual</span>
            {% endif %}
          </td>
          <td>{{ s.insumo.nombre }}</td>
          <td>{{ s.proveedor_sugerido.nombre|default:"-" }}</td>
          <td>
            {% if s.reabasto_nivel == 'critico' %}
              <span class="badge-rojo" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% elif s.reabasto_nivel == 'bajo' %}
              <span class="badge-amarillo" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% else %}
              <span class="badge-verde" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% endif %}
          </td>
          <td class="text-end">{{ s.cantidad }}</td>
          <td class="text-end">${{ s.costo_unitario|floatformat:2 }}</td>
          <td class="text-end">${{ s.presupuesto_estimado|floatformat:2 }}</td>
          <td>{{ s.fecha_requerida }}</td>
          <td>
            {% if s.estatus == 'APROBADA' %}
              <span class="badge bg-success">{{ s.get_estatus_display }}</span>
            {% elif s.estatus == 'RECHAZADA' %}
              <span class="badge bg-danger">{{ s.get_estatus_display }}</span>
            {% else %}
              <span class="badge bg-warning">{{ s.get_estatus_display }}</span>
            {% endif %}
          </td>
          {% if can_manage_compras %}
          <td>
            <div class="recipe-actions">
            {% if s.estatus == 'BORRADOR' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'EN_REVISION' %}" class="inline-form">{% csrf_token %}<button class="btn btn-secondary" type="submit">Enviar revisión</button></form>
            {% endif %}
            {% if s.estatus == 'BORRADOR' or s.estatus == 'EN_REVISION' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'APROBADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-success" type="submit">Aprobar</button></form>
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'RECHAZADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-danger" type="submit">Rechazar</button></form>
            {% endif %}
            {% if s.estatus == 'APROBADA' %}
              {% if s.has_open_order %}
                <a class="btn btn-secondary" href="{% url 'compras:ordenes' %}">OC activa {{ s.open_order_folio }}</a>
              {% else %}
                <form method="post" action="{% url 'compras:solicitud_crear_orden' s.id %}" class="inline-form">
                  {% csrf_token %}
                  <button class="btn btn-primary" type="submit">Crear OC</button>
                </form>
              {% endif %}
            {% endif %}
            <form method="post" action="{% url 'compras:solicitud_eliminar' s.id %}" class="inline-form" onsubmit="return confirm('¿Eliminar la solicitud {{ s.folio }}? Esta acción no se puede deshacer.');">
              {% csrf_token %}
              <input type="hidden" name="return_query" value="{{ current_query }}">
              <button class="btn btn-danger" type="submit" {% if s.has_open_order %}disabled title="Tiene OC activa"{% endif %}>Eliminar</button>
            </form>
            </div>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if can_manage_compras %}13{% else %}12{% endif %}" class="text-muted">Sin solicitudes capturadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="totals" style="margin-top: 10px;">
    <strong>Presupuesto estimado del filtro:</strong> ${{ total_presupuesto|floatformat:2 }}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const insumoSelect = document.getElementById("insumo_id");
    const cantidadInput = document.getElementById("cantidad");
    const stockHint = document.getElementById("stock-hint");
    if (insumoSelect && cantidadInput && stockHint) {
      function onInsumoChange() {
        const selected = insumoSelect.options[insumoSelect.selectedIndex];
        if (!selected || !selected.value) {
          stockHint.textContent = "Selecciona un insumo para ver stock, punto de reorden y sugerencia de compra.";
          return;
        }

        const stock = Number(selected.dataset.stock || 0);
        const reorden = Number(selected.dataset.reorden || 0);
        const recomendado = Number(selected.dataset.recomendado || 0);
        const proveedor = selected.dataset.proveedor || "-";

        if (!Number.isNaN(recomendado) && recomendado > 0) {
          cantidadInput.value = recomendado.toFixed(3);
          stockHint.textContent = "Stock: " + stock.toFixed(3) + " | Punto de reorden: " + reorden.toFixed(3) + " | Sugerido: " + recomendado.toFixed(3) + " | Proveedor: " + proveedor;
        } else {
          stockHint.textContent = "Stock: " + stock.toFixed(3) + " | Punto de reorden: " + reorden.toFixed(3) + " | No se requiere compra por reorden. | Proveedor: " + proveedor;
        }
      }

      insumoSelect.addEventListener("change", onInsumoChange);
    }

    const checkAll = document.getElementById("import-preview-check-all");
    const rowChecks = Array.from(document.querySelectorAll(".import-preview-row-check"));
    const readyCount = document.getElementById("preview-ready-count");
    if (!checkAll || rowChecks.length === 0) return;

    function syncCheckAllState() {
      const checkedCount = rowChecks.filter((x) => x.checked).length;
      checkAll.checked = checkedCount === rowChecks.length;
      checkAll.indeterminate = checkedCount > 0 && checkedCount < rowChecks.length;
      if (readyCount) {
        readyCount.textContent = String(checkedCount);
      }
    }

    checkAll.addEventListener("change", () => {
      rowChecks.forEach((x) => {
        x.checked = checkAll.checked;
      });
      syncCheckAllState();
    });

    rowChecks.forEach((x) => x.addEventListener("change", syncCheckAllState));
    syncCheckAllState();
  })();
</script>
{% endblock %}
