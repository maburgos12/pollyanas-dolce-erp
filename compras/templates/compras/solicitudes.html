{% extends "base.html" %}
{% block title %}Compras - Solicitudes{% endblock %}
{% block page_title %}Compras · Solicitudes{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab active" href="{% url 'compras:solicitudes' %}">Solicitudes</a>
  <a class="module-tab" href="{% url 'compras:ordenes' %}">Órdenes</a>
  <a class="module-tab" href="{% url 'compras:recepciones' %}">Recepciones</a>
</nav>

<section class="card">
  <div class="card-header">Nueva Solicitud</div>
  {% if can_manage_compras %}
  <form method="post" class="form-grid-auto">
    {% csrf_token %}
    <input class="input-field" name="area" placeholder="Área" required>
    <input class="input-field" name="solicitante" placeholder="Solicitante" required>
    <select class="input-field" id="insumo_id" name="insumo_id" required>
      <option value="">Insumo</option>
      {% for i in insumo_options %}
      <option
        value="{{ i.id }}"
        data-stock="{{ i.stock_actual }}"
        data-reorden="{{ i.punto_reorden }}"
        data-recomendado="{{ i.recomendado }}"
        data-proveedor="{{ i.proveedor_sugerido }}"
      >
        {{ i.nombre }}
      </option>
      {% endfor %}
    </select>
    <input class="input-field" id="cantidad" type="number" step="0.001" min="0" name="cantidad" placeholder="Cantidad" required>
    <input class="input-field" type="date" name="fecha_requerida" required>
    <select class="input-field" name="estatus">
      {% for value, label in status_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Guardar solicitud</button>
  </form>
  <p id="stock-hint" class="muted mb-0">Selecciona un insumo para ver stock, punto de reorden, sugerencia y proveedor principal.</p>
  {% else %}
  <p class="muted">Tu perfil está en modo lectura para Compras.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Solicitudes Registradas</div>
  <form method="get" class="form-grid-auto mb-3">
    <div>
      <label for="source">Origen</label>
      <select id="source" name="source" class="input-field">
        <option value="all" {% if source_filter == 'all' %}selected{% endif %}>Todos</option>
        <option value="manual" {% if source_filter == 'manual' %}selected{% endif %}>Manual</option>
        <option value="plan" {% if source_filter == 'plan' %}selected{% endif %}>Desde plan</option>
      </select>
    </div>
    <div>
      <label for="plan_id">Plan específico (opcional)</label>
      <select id="plan_id" name="plan_id" class="input-field">
        <option value="">Todos los planes</option>
        {% for p in plan_options %}
        <option value="{{ p.id }}" {% if plan_filter == p.id|stringformat:'s' %}selected{% endif %}>#{{ p.id }} · {{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="reabasto">Reabasto</label>
      <select id="reabasto" name="reabasto" class="input-field">
        <option value="all" {% if reabasto_filter == 'all' %}selected{% endif %}>Todos</option>
        <option value="critico" {% if reabasto_filter == 'critico' %}selected{% endif %}>Críticos</option>
        <option value="bajo" {% if reabasto_filter == 'bajo' %}selected{% endif %}>Bajo reorden</option>
        <option value="ok" {% if reabasto_filter == 'ok' %}selected{% endif %}>Suficiente</option>
      </select>
    </div>
    <div class="align-items-end d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar filtros</button>
      <a href="{% url 'compras:solicitudes' %}" class="btn btn-secondary">Limpiar</a>
    </div>
  </form>
  <div class="toolbar">
    <a href="{% url 'compras:solicitudes' %}?source={{ source_filter }}&plan_id={{ plan_filter }}" class="btn {% if reabasto_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">Todos</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=critico&source={{ source_filter }}&plan_id={{ plan_filter }}" class="btn {% if reabasto_filter == 'critico' %}btn-primary{% else %}btn-secondary{% endif %}">Críticos</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=bajo&source={{ source_filter }}&plan_id={{ plan_filter }}" class="btn {% if reabasto_filter == 'bajo' %}btn-primary{% else %}btn-secondary{% endif %}">Bajo reorden</a>
    <a href="{% url 'compras:solicitudes' %}?reabasto=ok&source={{ source_filter }}&plan_id={{ plan_filter }}" class="btn {% if reabasto_filter == 'ok' %}btn-primary{% else %}btn-secondary{% endif %}">Suficiente</a>
  </div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Área</th>
          <th>Solicitante</th>
          <th>Origen</th>
          <th>Insumo</th>
          <th>Proveedor sugerido</th>
          <th>Reabasto</th>
          <th class="text-end">Cantidad</th>
          <th>Fecha requerida</th>
          <th>Estatus</th>
          {% if can_manage_compras %}<th>Flujo</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in solicitudes %}
        <tr>
          <td>{{ s.folio }}</td>
          <td>{{ s.area }}</td>
          <td>{{ s.solicitante }}</td>
          <td>
            {% if s.source_tipo == 'plan' %}
              <span class="badge-amarillo"><a href="{% url 'recetas:plan_produccion' %}?plan_id={{ s.source_plan_id }}" style="color: inherit; text-decoration: none;">Plan #{{ s.source_plan_id }}</a></span>
            {% else %}
              <span class="badge-verde">Manual</span>
            {% endif %}
          </td>
          <td>{{ s.insumo.nombre }}</td>
          <td>{{ s.proveedor_sugerido.nombre|default:"-" }}</td>
          <td>
            {% if s.reabasto_nivel == 'critico' %}
              <span class="badge-rojo" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% elif s.reabasto_nivel == 'bajo' %}
              <span class="badge-amarillo" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% else %}
              <span class="badge-verde" title="{{ s.reabasto_detalle }}">{{ s.reabasto_texto }}</span>
            {% endif %}
          </td>
          <td class="text-end">{{ s.cantidad }}</td>
          <td>{{ s.fecha_requerida }}</td>
          <td>
            {% if s.estatus == 'APROBADA' %}
              <span class="badge bg-success">{{ s.get_estatus_display }}</span>
            {% elif s.estatus == 'RECHAZADA' %}
              <span class="badge bg-danger">{{ s.get_estatus_display }}</span>
            {% else %}
              <span class="badge bg-warning">{{ s.get_estatus_display }}</span>
            {% endif %}
          </td>
          {% if can_manage_compras %}
          <td>
            <div class="recipe-actions">
            {% if s.estatus == 'BORRADOR' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'EN_REVISION' %}" class="inline-form">{% csrf_token %}<button class="btn btn-secondary" type="submit">Enviar revisión</button></form>
            {% endif %}
            {% if s.estatus == 'BORRADOR' or s.estatus == 'EN_REVISION' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'APROBADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-success" type="submit">Aprobar</button></form>
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'RECHAZADA' %}" class="inline-form">{% csrf_token %}<button class="btn btn-danger" type="submit">Rechazar</button></form>
            {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if can_manage_compras %}11{% else %}10{% endif %}" class="text-muted">Sin solicitudes capturadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const insumoSelect = document.getElementById("insumo_id");
    const cantidadInput = document.getElementById("cantidad");
    const stockHint = document.getElementById("stock-hint");
    if (!insumoSelect || !cantidadInput || !stockHint) return;

    function onInsumoChange() {
      const selected = insumoSelect.options[insumoSelect.selectedIndex];
      if (!selected || !selected.value) {
        stockHint.textContent = "Selecciona un insumo para ver stock, punto de reorden y sugerencia de compra.";
        return;
      }

      const stock = Number(selected.dataset.stock || 0);
      const reorden = Number(selected.dataset.reorden || 0);
      const recomendado = Number(selected.dataset.recomendado || 0);
      const proveedor = selected.dataset.proveedor || "-";

      if (!Number.isNaN(recomendado) && recomendado > 0) {
        cantidadInput.value = recomendado.toFixed(3);
        stockHint.textContent = "Stock: " + stock.toFixed(3) + " | Punto de reorden: " + reorden.toFixed(3) + " | Sugerido: " + recomendado.toFixed(3) + " | Proveedor: " + proveedor;
      } else {
        stockHint.textContent = "Stock: " + stock.toFixed(3) + " | Punto de reorden: " + reorden.toFixed(3) + " | No se requiere compra por reorden. | Proveedor: " + proveedor;
      }
    }

    insumoSelect.addEventListener("change", onInsumoChange);
  })();
</script>
{% endblock %}
