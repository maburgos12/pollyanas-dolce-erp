{% extends "base.html" %}
{% block title %}Compras - Solicitudes{% endblock %}
{% block page_title %}Compras · Solicitudes{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab active" href="{% url 'compras:solicitudes' %}">Solicitudes</a>
  <a class="module-tab" href="{% url 'compras:ordenes' %}">Órdenes</a>
  <a class="module-tab" href="{% url 'compras:recepciones' %}">Recepciones</a>
</nav>

<section class="card">
  <div class="card-header">Nueva Solicitud</div>
  {% if can_manage_compras %}
  <form method="post" class="quick-actions" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;">
    {% csrf_token %}
    <input class="input-field" name="area" placeholder="Área" required>
    <input class="input-field" name="solicitante" placeholder="Solicitante" required>
    <select class="input-field" name="insumo_id" required>
      <option value="">Insumo</option>
      {% for i in insumos %}<option value="{{ i.id }}">{{ i.nombre }}</option>{% endfor %}
    </select>
    <input class="input-field" type="number" step="0.001" min="0" name="cantidad" placeholder="Cantidad" required>
    <input class="input-field" type="date" name="fecha_requerida" required>
    <select class="input-field" name="estatus">
      {% for value, label in status_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Guardar solicitud</button>
  </form>
  {% else %}
  <p class="muted">Tu perfil está en modo lectura para Compras.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Solicitudes Registradas</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Área</th>
          <th>Solicitante</th>
          <th>Insumo</th>
          <th class="text-end">Cantidad</th>
          <th>Fecha requerida</th>
          <th>Estatus</th>
          {% if can_manage_compras %}<th>Flujo</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for s in solicitudes %}
        <tr>
          <td>{{ s.folio }}</td>
          <td>{{ s.area }}</td>
          <td>{{ s.solicitante }}</td>
          <td>{{ s.insumo.nombre }}</td>
          <td class="text-end">{{ s.cantidad }}</td>
          <td>{{ s.fecha_requerida }}</td>
          <td>
            {% if s.estatus == 'APROBADA' %}
              <span class="badge bg-success">{{ s.get_estatus_display }}</span>
            {% elif s.estatus == 'RECHAZADA' %}
              <span class="badge bg-danger">{{ s.get_estatus_display }}</span>
            {% else %}
              <span class="badge bg-warning">{{ s.get_estatus_display }}</span>
            {% endif %}
          </td>
          {% if can_manage_compras %}
          <td>
            {% if s.estatus == 'BORRADOR' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'EN_REVISION' %}" style="display:inline;">{% csrf_token %}<button class="btn btn-secondary" type="submit">Enviar revisión</button></form>
            {% endif %}
            {% if s.estatus == 'BORRADOR' or s.estatus == 'EN_REVISION' %}
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'APROBADA' %}" style="display:inline;">{% csrf_token %}<button class="btn btn-success" type="submit">Aprobar</button></form>
              <form method="post" action="{% url 'compras:solicitud_estatus' s.id 'RECHAZADA' %}" style="display:inline;">{% csrf_token %}<button class="btn btn-danger" type="submit">Rechazar</button></form>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-muted">Sin solicitudes capturadas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
