{% extends "base.html" %}
{% block title %}Inventario - Ajustes{% endblock %}
{% block page_title %}Inventario · Ajustes{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'inventario:existencias' %}">Existencias</a>
  <a class="module-tab" href="{% url 'inventario:movimientos' %}">Movimientos</a>
  <a class="module-tab active" href="{% url 'inventario:ajustes' %}">Ajustes</a>
  <a class="module-tab" href="{% url 'inventario:alertas' %}">Alertas</a>
  <a class="module-tab" href="{% url 'inventario:aliases_catalog' %}">Aliases</a>
  <a class="module-tab" href="{% url 'inventario:importar_archivos' %}">Carga Almacén</a>
</nav>

<section class="card">
  <div class="card-header">Nuevo Ajuste</div>
  {% if can_manage_inventario %}
  <form method="post" class="form-grid-auto">
    {% csrf_token %}
    <input type="hidden" name="action" value="create">
    <select class="input-field" name="insumo_id" required>
      <option value="">Insumo</option>
      {% for i in insumos %}<option value="{{ i.id }}">{{ i.nombre }}</option>{% endfor %}
    </select>
    <input class="input-field" type="number" min="0" step="0.001" name="cantidad_sistema" placeholder="Cantidad sistema" required>
    <input class="input-field" type="number" min="0" step="0.001" name="cantidad_fisica" placeholder="Cantidad física" required>
    <input class="input-field" name="motivo" placeholder="Motivo" required>
    {% if can_approve_ajustes %}
    <label class="inline-check"><input type="checkbox" name="create_and_apply" value="1"> Aprobar y aplicar inmediato</label>
    <input class="input-field" name="comentario_revision" placeholder="Comentario aprobación (opcional)">
    {% endif %}
    <button class="btn btn-primary" type="submit">Registrar ajuste</button>
  </form>
  {% else %}
  <p class="muted">Tu perfil está en modo lectura para Inventario.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Ajustes Registrados</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Folio</th>
          <th>Insumo</th>
          <th>Solicitó</th>
          <th class="text-end">Sistema</th>
          <th class="text-end">Físico</th>
          <th>Motivo</th>
          <th>Estatus</th>
          <th>Revisión</th>
          {% if can_approve_ajustes %}<th>Acciones</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for a in ajustes %}
        <tr>
          <td>{{ a.folio }}</td>
          <td>{{ a.insumo.nombre }}</td>
          <td>{% if a.solicitado_por %}{{ a.solicitado_por.username }}{% else %}-{% endif %}</td>
          <td class="text-end">{{ a.cantidad_sistema }}</td>
          <td class="text-end">{{ a.cantidad_fisica }}</td>
          <td>{{ a.motivo }}</td>
          <td>
            {% if a.estatus == "APLICADO" %}
              <span class="badge bg-success">{{ a.get_estatus_display }}</span>
            {% elif a.estatus == "RECHAZADO" %}
              <span class="badge bg-danger">{{ a.get_estatus_display }}</span>
            {% else %}
              <span class="badge bg-warning text-dark">{{ a.get_estatus_display }}</span>
            {% endif %}
          </td>
          <td>
            {% if a.aprobado_por %}
              {{ a.aprobado_por.username }} · {{ a.aprobado_en|date:"Y-m-d H:i" }}
            {% else %}
              -
            {% endif %}
            {% if a.comentario_revision %}
              <div class="text-muted">{{ a.comentario_revision }}</div>
            {% endif %}
          </td>
          {% if can_approve_ajustes %}
          <td>
            {% if a.estatus == "PENDIENTE" %}
            <form method="post" class="d-flex gap-2 flex-wrap">
              {% csrf_token %}
              <input type="hidden" name="action" value="approve">
              <input type="hidden" name="ajuste_id" value="{{ a.id }}">
              <input class="input-field" name="comentario_revision" placeholder="Comentario (opcional)">
              <button class="btn btn-primary btn-small" type="submit">Aprobar y aplicar</button>
            </form>
            <form method="post" class="d-flex gap-2 mt-1">
              {% csrf_token %}
              <input type="hidden" name="action" value="reject">
              <input type="hidden" name="ajuste_id" value="{{ a.id }}">
              <input class="input-field" name="comentario_revision" placeholder="Motivo rechazo" required>
              <button class="btn btn-danger btn-small" type="submit">Rechazar</button>
            </form>
            {% else %}
            <span class="text-muted">Sin acciones</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr><td colspan="{% if can_approve_ajustes %}10{% else %}9{% endif %}" class="text-muted">Sin ajustes registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
