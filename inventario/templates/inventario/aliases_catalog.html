{% extends "base.html" %}
{% block title %}Inventario - Aliases{% endblock %}
{% block page_title %}Inventario · Aliases{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'inventario:existencias' %}">Existencias</a>
  <a class="module-tab" href="{% url 'inventario:movimientos' %}">Movimientos</a>
  <a class="module-tab" href="{% url 'inventario:ajustes' %}">Ajustes</a>
  <a class="module-tab" href="{% url 'inventario:alertas' %}">Alertas</a>
  <a class="module-tab active" href="{% url 'inventario:aliases_catalog' %}">Aliases</a>
  <a class="module-tab" href="{% url 'inventario:importar_archivos' %}">Carga Almacén</a>
</nav>

<section class="card">
  <div class="card-header">Resumen de Matching (Almacén)</div>
  <div class="kpi-grid kpi-mini">
    <article class="kpi-card">
      <div class="kpi-number is-success">{{ matching_summary.total_matched }}</div>
      <div class="kpi-label">Matches (últimos {{ matching_summary.runs_count }} syncs)</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if matching_summary.total_unmatched > 0 %}is-danger{% else %}is-success{% endif %}">{{ matching_summary.total_unmatched }}</div>
      <div class="kpi-label">Sin match (últimos {{ matching_summary.runs_count }} syncs)</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if matching_summary.match_rate >= 98 %}is-success{% elif matching_summary.match_rate >= 95 %}is-warning{% else %}is-danger{% endif %}">
        {{ matching_summary.match_rate|floatformat:2 }}%
      </div>
      <div class="kpi-label">Tasa de match</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number">{{ matching_summary.ok_runs }}/{{ matching_summary.runs_count }}</div>
      <div class="kpi-label">Sync OK</div>
    </article>
  </div>
  {% if latest_sync %}
  <p class="muted" style="margin-top:10px;">
    Último sync: {{ latest_sync.started_at|date:"Y-m-d H:i" }} ·
    Origen {{ latest_sync.get_source_display }} ·
    Match {{ latest_sync.matched }} ·
    Sin match {{ latest_sync.unmatched }} ·
    Filas inventario {{ latest_sync.rows_stock_read }} ·
    Filas movimientos {{ latest_sync.rows_mov_read }}.
  </p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Homologación Cruzada (Point + Almacén + Recetas)</div>
  <p class="muted">Prioriza nombres que aparezcan en 2 o 3 fuentes para normalizar todo el ecosistema con un solo alias.</p>

  <div class="kpi-grid kpi-mini">
    <article class="kpi-card">
      <div class="kpi-number {% if cross_summary.point_unmatched > 0 %}is-danger{% else %}is-success{% endif %}">{{ cross_summary.point_unmatched }}</div>
      <div class="kpi-label">Pendientes Point (insumos)</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if cross_summary.almacen_unmatched > 0 %}is-danger{% else %}is-success{% endif %}">{{ cross_summary.almacen_unmatched }}</div>
      <div class="kpi-label">Pendientes Almacén</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if cross_summary.recetas_unmatched > 0 %}is-danger{% else %}is-success{% endif %}">{{ cross_summary.recetas_unmatched }}</div>
      <div class="kpi-label">Líneas recetas sin match</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if cross_summary.overlaps > 0 %}is-warning{% else %}is-success{% endif %}">{{ cross_summary.overlaps }}</div>
      <div class="kpi-label">Nombres en 2+ fuentes</div>
    </article>
  </div>

  <div class="toolbar" style="margin-top:10px;">
    <a class="btn btn-secondary" href="{% url 'maestros:point_pending_review' %}?tipo=INSUMO">Revisar pendientes Point</a>
    <a class="btn btn-secondary" href="{% url 'recetas:matching_pendientes' %}">Revisar pendientes Recetas</a>
    <a class="btn btn-secondary" href="{% url 'inventario:aliases_catalog' %}?export=cross_pending_csv">Exportar pendientes CSV</a>
    {% if can_manage_inventario %}
    <form method="post" class="inline-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="reprocess_recetas_pending">
      <button class="btn btn-primary" type="submit">Reprocesar pendientes recetas</button>
    </form>
    {% endif %}
  </div>

  {% if cross_unified_rows %}
  <div class="table-responsive" style="margin-top:10px;">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Normalizado</th>
          <th class="text-end">Point</th>
          <th class="text-end">Almacén</th>
          <th class="text-end">Recetas</th>
          <th class="text-end">Fuentes</th>
          <th>Sugerencia</th>
          <th class="text-end">Score máx</th>
          {% if can_manage_inventario %}<th>Acción</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in cross_unified_rows %}
        <tr>
          <td>{{ row.nombre_muestra }}</td>
          <td><code>{{ row.nombre_normalizado }}</code></td>
          <td class="text-end">{{ row.point_count }}</td>
          <td class="text-end">{{ row.almacen_count }}</td>
          <td class="text-end">{{ row.receta_count }}</td>
          <td class="text-end">{{ row.sources_active }}</td>
          <td>{{ row.suggestion|default:"-" }}</td>
          <td class="text-end">{{ row.score_max|floatformat:1 }}</td>
          {% if can_manage_inventario %}
          <td>
            <button type="button" class="btn btn-secondary copy-pending-name" data-name="{{ row.nombre_muestra|escape }}">Usar en alta</button>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="muted" style="margin-top:10px;">Sin pendientes cruzados para homologar.</p>
  {% endif %}
</section>

{% if can_manage_inventario %}
<section class="card">
  <div class="card-header">Crear Alias</div>
  <p class="muted">Unifica nombres de almacén contra el catálogo oficial de insumos para evitar errores en cálculos, compras y reportes.</p>
  <form method="post" class="form-grid-2">
    {% csrf_token %}
    <input type="hidden" name="action" value="create">
    <input type="hidden" name="next_q" value="{{ q }}">
    <div class="form-group">
      <label>Nombre origen (almacén)</label>
      <input id="alias_name_input" class="input-field" type="text" name="alias_name" required placeholder="Ej. Harina pastelera 25kg">
    </div>
    <div class="form-group">
      <label>Insumo oficial</label>
      <select class="input-field" name="insumo_id" required>
        <option value="">Selecciona insumo...</option>
        {% for i in insumo_alias_targets %}
        <option value="{{ i.id }}">{{ i.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="grid-column:1/-1; display:flex; justify-content:flex-end;">
      <button class="btn btn-primary" type="submit">Guardar alias</button>
    </div>
  </form>
</section>
{% endif %}

{% if can_manage_inventario %}
<section class="card">
  <div class="card-header">Carga Masiva de Aliases (CSV/XLSX)</div>
  <p class="muted">Columnas sugeridas: <code>alias</code>, <code>insumo</code>. Si no mandas <code>insumo</code>, se intentará resolver por el alias con score mínimo.</p>
  <div class="toolbar" style="margin-top:8px; margin-bottom:8px;">
    <a class="btn btn-secondary" href="{% url 'inventario:aliases_catalog' %}?export=alias_template_csv">Descargar plantilla CSV</a>
    <a class="btn btn-secondary" href="{% url 'inventario:aliases_catalog' %}?export=alias_template_xlsx">Descargar plantilla XLSX</a>
  </div>
  <form method="post" enctype="multipart/form-data" class="form-grid-auto">
    {% csrf_token %}
    <input type="hidden" name="action" value="import_bulk">
    <input type="hidden" name="next_q" value="{{ q }}">
    <input class="input-field" type="file" name="archivo_aliases" accept=".csv,.xlsx,.xlsm" required>
    <input class="input-field" type="number" name="score_min" min="0" max="100" step="0.1" value="{% if alias_import_stats.score_min %}{{ alias_import_stats.score_min }}{% else %}90{% endif %}">
    <button class="btn btn-primary" type="submit">Importar aliases</button>
  </form>

  {% if alias_import_stats.rows_total %}
  <div class="kpi-grid kpi-mini" style="margin-top:12px;">
    <article class="kpi-card">
      <div class="kpi-number">{{ alias_import_stats.rows_total }}</div>
      <div class="kpi-label">Filas archivo</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number is-success">{{ alias_import_stats.created }}</div>
      <div class="kpi-label">Aliases creados</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number is-warning">{{ alias_import_stats.updated }}</div>
      <div class="kpi-label">Aliases actualizados</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if alias_import_stats.unresolved %}is-danger{% else %}is-success{% endif %}">{{ alias_import_stats.unresolved }}</div>
      <div class="kpi-label">Sin resolver</div>
    </article>
  </div>
  <p class="muted" style="margin-top:8px;">
    Archivo: {{ alias_import_stats.file_name }} ·
    Score mínimo: {{ alias_import_stats.score_min|floatformat:1 }} ·
    Point resueltos: {{ alias_import_stats.point_resolved }} ·
    Recetas resueltas: {{ alias_import_stats.recetas_resolved }}.
  </p>
  {% endif %}
</section>
{% endif %}

{% if can_manage_inventario and alias_import_preview %}
<section class="card">
  <div class="card-header">Pendientes de Importación (Alias)</div>
  <p class="muted">Filas que no se pudieron aplicar automáticamente. Corrige el nombre de insumo o usa "Usar en alta".</p>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Fila</th>
          <th>Alias archivo</th>
          <th>Insumo archivo</th>
          <th>Sugerencia</th>
          <th class="text-end">Score</th>
          <th>Método</th>
          <th>Motivo</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for r in alias_import_preview %}
        <tr>
          <td>{{ r.row }}</td>
          <td>{{ r.alias|default:"-" }}</td>
          <td>{{ r.insumo_archivo|default:"-" }}</td>
          <td>{{ r.sugerencia|default:"-" }}</td>
          <td class="text-end">{{ r.score|floatformat:1 }}</td>
          <td>{{ r.method }}</td>
          <td>{{ r.motivo }}</td>
          <td><button type="button" class="btn btn-secondary copy-pending-name" data-name="{{ r.alias|escape }}">Usar en alta</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <form method="post" style="display:flex; justify-content:flex-end; margin-top:8px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="clear_import_preview">
    <button class="btn btn-secondary" type="submit">Limpiar pendientes de importación</button>
  </form>
</section>
{% endif %}

<section class="card">
  <div class="card-header">Pendientes Recientes de Match (Almacén)</div>
  <div class="kpi-grid kpi-mini">
    <article class="kpi-card">
      <div class="kpi-number {% if pending_visible_count > 0 %}is-danger{% else %}is-success{% endif %}">{{ pending_visible_count }}</div>
      <div class="kpi-label">Pendientes en pantalla</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if pending_unique_count > 0 %}is-warning{% else %}is-success{% endif %}">{{ pending_unique_count }}</div>
      <div class="kpi-label">Pendientes únicos</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number">{{ matching_summary.runs_count }}</div>
      <div class="kpi-label">Syncs auditados</div>
    </article>
    <article class="kpi-card">
      <div class="kpi-number {% if matching_summary.total_unmatched > 0 %}is-danger{% else %}is-success{% endif %}">{{ matching_summary.total_unmatched }}</div>
      <div class="kpi-label">Sin match acumulado</div>
    </article>
  </div>
  {% if pending_source == "session" %}
  <p class="muted">Fuente: sesión actual (última importación manual en este navegador).</p>
  {% elif pending_source == "persisted" and latest_pending_run %}
  <p class="muted">Fuente: último sync con pendientes ({{ latest_pending_run.started_at|date:"Y-m-d H:i" }}).</p>
  {% else %}
  <p class="muted">
    No hay pendientes recientes en pantalla.
    {% if latest_sync %}Último sync: {{ latest_sync.started_at|date:"Y-m-d H:i" }} · Sin match: {{ latest_sync.unmatched }}.{% endif %}
  </p>
  {% endif %}
  {% if hidden_pending_run and can_manage_inventario %}
  <div class="toolbar" style="margin-top:10px;">
    <span class="muted">
      Hay un run oculto: #{{ hidden_pending_run.id }} ({{ hidden_pending_run.started_at|date:"Y-m-d H:i" }}).
    </span>
    <form method="post" class="inline-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="reset_hidden_pending">
      <button class="btn btn-secondary" type="submit">Restaurar visibilidad</button>
    </form>
  </div>
  {% endif %}

  {% if pending_recent_runs %}
  <div class="table-responsive" style="margin-top:12px;">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Origen</th>
          <th>Estatus</th>
          <th class="text-end">Match</th>
          <th class="text-end">Sin match</th>
          <th>Detalle</th>
          {% if can_manage_inventario %}<th>Acción</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for run in pending_recent_runs %}
        <tr>
          <td>{{ run.started_at|date:"Y-m-d H:i" }}</td>
          <td>{{ run.source_label }}</td>
          <td>{{ run.status }}</td>
          <td class="text-end">{{ run.matched }}</td>
          <td class="text-end">{{ run.unmatched }}</td>
          <td>
            {% if run.has_preview %}
              {% if run.is_hidden %}<span class="badge-amarillo">Oculto</span>{% else %}<span class="badge-verde">Con preview</span>{% endif %}
            {% else %}
              <span class="text-muted">Sin preview</span>
            {% endif %}
          </td>
          {% if can_manage_inventario %}
          <td>
            {% if run.has_preview %}
            <form method="post" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="load_pending_run">
              <input type="hidden" name="run_id" value="{{ run.id }}">
              <button class="btn btn-secondary" type="submit">Cargar pendientes</button>
            </form>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if pending_preview %}
    <p class="muted">Da clic en "Usar en alta" para copiar el nombre origen y crear el alias rápido.</p>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Fuente</th>
            <th>Fila</th>
            <th>Nombre origen</th>
            <th>Sugerencia</th>
            <th class="text-end">Score</th>
            {% if can_manage_inventario %}<th>Acción</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for p in pending_preview %}
          <tr>
            <td>{{ p.source }}</td>
            <td>{{ p.row }}</td>
            <td>{{ p.nombre_origen }}</td>
            <td>{{ p.sugerencia|default:"-" }}</td>
            <td class="text-end">{{ p.score }}</td>
            {% if can_manage_inventario %}
            <td>
              <button type="button" class="btn btn-secondary copy-pending-name" data-name="{{ p.nombre_origen|escape }}">Usar en alta</button>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if can_manage_inventario %}
    <form method="post" style="display:flex; justify-content:flex-end; margin-top:8px;">
      {% csrf_token %}
      <input type="hidden" name="action" value="clear_pending">
      {% if latest_pending_run %}<input type="hidden" name="hide_run_id" value="{{ latest_pending_run.id }}">{% endif %}
      <button class="btn btn-secondary" type="submit">Limpiar pendientes en pantalla</button>
    </form>
    {% endif %}
  {% endif %}
</section>

{% if pending_grouped %}
<section class="card">
  <div class="card-header">Pendientes Agrupados Para Corrección</div>
  <p class="muted">Prioriza los de mayor frecuencia para corregir más rápido.</p>
  {% if can_manage_inventario %}
  <form method="post" class="form-grid-auto" style="margin-top:10px; margin-bottom:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="auto_apply_suggestions">
    <input type="hidden" name="next_q" value="{{ q }}">
    <label class="muted" for="auto_min_score">Score mínimo</label>
    <input id="auto_min_score" class="input-field" type="number" name="auto_min_score" min="0" max="100" step="0.1" value="{{ auto_default_score|floatformat:1 }}">
    <label class="muted" for="auto_max_rows">Máx. filas a aplicar</label>
    <input id="auto_max_rows" class="input-field" type="number" name="auto_max_rows" min="1" max="500" step="1" value="{{ auto_default_limit }}">
    <button class="btn btn-primary" type="submit">Auto-aplicar sugerencias</button>
    <span class="muted">Candidatos estimados: {{ auto_apply_candidates }}</span>
  </form>
  {% endif %}
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Nombre origen</th>
          <th>Normalizado</th>
          <th>Fuentes</th>
          <th class="text-end">Repeticiones</th>
          <th>Sugerencia</th>
          <th class="text-end">Score máx</th>
          {% if can_manage_inventario %}<th>Acción</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for p in pending_grouped %}
        <tr>
          <td>{{ p.nombre_origen }}</td>
          <td><code>{{ p.nombre_normalizado }}</code></td>
          <td>{{ p.sources }}</td>
          <td class="text-end">{{ p.count }}</td>
          <td>{{ p.sugerencia|default:"-" }}</td>
          <td class="text-end">{{ p.score_max|floatformat:1 }}</td>
          {% if can_manage_inventario %}
          <td>
            <button type="button" class="btn btn-secondary copy-pending-name" data-name="{{ p.nombre_origen|escape }}">Usar en alta</button>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<section class="card">
  <div class="card-header">Catálogo de Aliases</div>
  <form method="get" class="form-grid-auto mb-3">
    <input class="input-field" type="text" name="q" value="{{ q }}" placeholder="Buscar por alias o insumo...">
    <button class="btn btn-primary" type="submit">Buscar</button>
    <a href="{% url 'inventario:aliases_catalog' %}" class="btn btn-secondary">Limpiar</a>
  </form>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          {% if can_manage_inventario %}<th><input id="check-all-aliases" type="checkbox" form="bulk-form"></th>{% endif %}
          <th>Alias</th>
          <th>Normalizado</th>
          <th>Insumo oficial</th>
          {% if can_manage_inventario %}<th>Acción</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for a in page.object_list %}
        <tr>
          {% if can_manage_inventario %}
          <td><input type="checkbox" name="alias_ids" value="{{ a.id }}" form="bulk-form"></td>
          {% endif %}
          <td>{{ a.nombre }}</td>
          <td><code>{{ a.nombre_normalizado }}</code></td>
          <td>{{ a.insumo.nombre }}</td>
          {% if can_manage_inventario %}
          <td>
            <form method="post" class="inline-form" onsubmit="return confirm('¿Eliminar alias {{ a.nombre|escapejs }}?');">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="alias_id" value="{{ a.id }}">
              <input type="hidden" name="next_q" value="{{ q }}">
              <button class="btn btn-danger" type="submit">Eliminar</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{% if can_manage_inventario %}5{% else %}3{% endif %}" class="text-muted">Sin aliases para el filtro actual.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if can_manage_inventario %}
  <form id="bulk-form" method="post" class="form-grid-auto" style="margin-top:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="bulk_reassign">
    <input type="hidden" name="next_q" value="{{ q }}">
    <select class="input-field" name="insumo_id" required>
      <option value="">Reasignar seleccionados a...</option>
      {% for i in insumo_alias_targets %}
      <option value="{{ i.id }}">{{ i.nombre }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary" type="submit">Aplicar reasignación masiva</button>
  </form>
  {% endif %}

  {% if page.paginator.num_pages > 1 %}
  <div class="toolbar" style="margin-top:10px;">
    {% if page.has_previous %}
    <a class="btn btn-secondary" href="?q={{ q|urlencode }}&page={{ page.previous_page_number }}">Anterior</a>
    {% endif %}
    <span class="muted">Página {{ page.number }} de {{ page.paginator.num_pages }}</span>
    {% if page.has_next %}
    <a class="btn btn-secondary" href="?q={{ q|urlencode }}&page={{ page.next_page_number }}">Siguiente</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const aliasInput = document.getElementById("alias_name_input");
    document.querySelectorAll(".copy-pending-name").forEach((btn) => {
      btn.addEventListener("click", () => {
        if (!aliasInput) return;
        aliasInput.value = btn.dataset.name || "";
        aliasInput.focus();
      });
    });

    const checkAll = document.getElementById("check-all-aliases");
    if (!checkAll) return;
    checkAll.addEventListener("change", () => {
      document.querySelectorAll('input[name="alias_ids"]').forEach((el) => {
        el.checked = checkAll.checked;
      });
    });
  })();
</script>
{% endblock %}
