{% extends "base.html" %}
{% block title %}Inventario - Carga de Almacén{% endblock %}
{% block page_title %}Inventario · Carga de Almacén{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'inventario:existencias' %}">Existencias</a>
  <a class="module-tab" href="{% url 'inventario:movimientos' %}">Movimientos</a>
  <a class="module-tab" href="{% url 'inventario:ajustes' %}">Ajustes</a>
  <a class="module-tab" href="{% url 'inventario:alertas' %}">Alertas</a>
  <a class="module-tab active" href="{% url 'inventario:importar_archivos' %}">Carga Almacén</a>
</nav>

{% if can_manage_inventario %}
<section class="card">
  <div class="card-header">Sincronizar Desde Google Drive</div>
  <p class="muted">Conecta con la carpeta mensual de almacén (por ejemplo: <code>ALMACEN ENERO 2026</code>) y procesa archivos automáticamente.</p>

  <form method="post" class="form-grid-2">
    {% csrf_token %}
    <input type="hidden" name="action" value="drive">

    <div class="form-group">
      <label>Mes objetivo</label>
      <input class="input-field" type="month" name="month" value="{{ current_month }}">
    </div>

    <div class="form-group" style="display:flex; flex-direction:column; justify-content:flex-end;">
      <small class="muted">Si no existe ese mes, se usa fallback al mes anterior.</small>
    </div>

    <div class="form-group" style="grid-column: 1 / -1;">
      <label>Fuentes a importar</label>
      <div class="quick-actions">
        {% for value, label in sources %}
          <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" name="sources" value="{{ value }}" checked>
            <span>{{ label }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label>Fuzzy threshold</label>
      <input class="input-field" type="number" name="fuzzy_threshold" min="80" max="100" value="{{ defaults.fuzzy_threshold }}">
    </div>

    <div class="form-group" style="display:flex; flex-direction:column; justify-content:flex-end; gap:8px;">
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="create_missing_insumos" {% if defaults.create_missing_insumos %}checked{% endif %}>
        <span>Crear insumos faltantes</span>
      </label>
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="create_aliases" {% if defaults.create_aliases %}checked{% endif %}>
        <span>Crear aliases automáticos</span>
      </label>
    </div>

    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
      <button class="btn btn-primary" type="submit">Sincronizar ahora</button>
    </div>
  </form>
</section>

<section class="card">
  <div class="card-header">Subir Archivos Manualmente (XLSX)</div>
  <p class="muted">Sube uno o varios archivos desde tu computadora. El sistema detecta Inventario, Entradas, Salidas y Merma por nombre.</p>

  <form method="post" enctype="multipart/form-data" class="form-grid-2">
    {% csrf_token %}
    <input type="hidden" name="action" value="upload">

    <div class="form-group" style="grid-column: 1 / -1;">
      <label>Archivos .xlsx</label>
      <input class="input-field" type="file" name="archivos" accept=".xlsx" multiple required>
    </div>

    <div class="form-group" style="grid-column: 1 / -1;">
      <label>Fuentes a importar</label>
      <div class="quick-actions">
        {% for value, label in sources %}
          <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" name="sources" value="{{ value }}" checked>
            <span>{{ label }}</span>
          </label>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label>Fuzzy threshold</label>
      <input class="input-field" type="number" name="fuzzy_threshold" min="80" max="100" value="{{ defaults.fuzzy_threshold }}">
    </div>

    <div class="form-group" style="display:flex; flex-direction:column; justify-content:flex-end; gap:8px;">
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="create_missing_insumos" {% if defaults.create_missing_insumos %}checked{% endif %}>
        <span>Crear insumos faltantes</span>
      </label>
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="create_aliases" {% if defaults.create_aliases %}checked{% endif %}>
        <span>Crear aliases automáticos</span>
      </label>
    </div>

    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end;">
      <button class="btn btn-secondary" type="submit">Procesar carga manual</button>
    </div>
  </form>
</section>

<section class="card">
  <div class="card-header">Nombres Esperados</div>
  <ul>
    {% for n in expected_names %}
    <li><code>{{ n }}</code></li>
    {% endfor %}
  </ul>
  {% if drive_info %}
  <hr>
  <p class="muted">
    Último sync Drive:
    carpeta <strong>{{ drive_info.folder_name }}</strong>,
    mes objetivo {{ drive_info.target_month }},
    fuentes descargadas: {{ drive_info.downloaded_sources|join:", " }}.
    {% if drive_info.used_fallback_month %}(fallback aplicado){% endif %}
  </p>
  {% endif %}
</section>
{% else %}
<section class="card">
  <p class="muted">Tu perfil está en modo lectura para Inventario.</p>
</section>
{% endif %}

{% if summary %}
<section class="card">
  <div class="card-header">Resumen de importación</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <tbody>
        <tr><th>Filas inventario leídas</th><td class="text-end">{{ summary.rows_stock_read }}</td></tr>
        <tr><th>Filas movimientos leídas</th><td class="text-end">{{ summary.rows_mov_read }}</td></tr>
        <tr><th>Matches</th><td class="text-end">{{ summary.matched }}</td></tr>
        <tr><th>Sin match</th><td class="text-end">{{ summary.unmatched }}</td></tr>
        <tr><th>Insumos creados</th><td class="text-end">{{ summary.insumos_created }}</td></tr>
        <tr><th>Existencias actualizadas</th><td class="text-end">{{ summary.existencias_updated }}</td></tr>
        <tr><th>Movimientos creados</th><td class="text-end">{{ summary.movimientos_created }}</td></tr>
        <tr><th>Duplicados omitidos</th><td class="text-end">{{ summary.movimientos_skipped_duplicate }}</td></tr>
        <tr><th>Aliases creados</th><td class="text-end">{{ summary.aliases_created }}</td></tr>
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% if latest_runs %}
<section class="card">
  <div class="card-header">Últimas Sincronizaciones</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Origen</th>
          <th>Estatus</th>
          <th>Carpeta / Mes</th>
          <th>Resultados</th>
          <th>Ejecutado por</th>
        </tr>
      </thead>
      <tbody>
        {% for run in latest_runs %}
        <tr>
          <td>{{ run.started_at|date:"Y-m-d H:i" }}</td>
          <td>{{ run.get_source_display }}</td>
          <td>
            {% if run.status == "OK" %}
            <span class="badge badge-success">OK</span>
            {% else %}
            <span class="badge badge-danger">ERROR</span>
            {% endif %}
          </td>
          <td>
            {% if run.folder_name %}<div><strong>{{ run.folder_name }}</strong></div>{% endif %}
            {% if run.target_month %}<div>{{ run.target_month }}{% if run.fallback_used %} (fallback){% endif %}</div>{% endif %}
          </td>
          <td>
            <div>Existencias: {{ run.existencias_updated }} · Movimientos: {{ run.movimientos_created }}</div>
            <div>Matches: {{ run.matched }} · Sin match: {{ run.unmatched }}</div>
          </td>
          <td>{{ run.triggered_by.username|default:"Sistema" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% if pendientes_preview %}
<section class="card">
  <div class="card-header">Pendientes de match (muestra)</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Fuente</th>
          <th>Fila</th>
          <th>Nombre origen</th>
          <th>Sugerencia</th>
          <th class="text-end">Score</th>
        </tr>
      </thead>
      <tbody>
        {% for p in pendientes_preview %}
        <tr>
          <td>{{ p.source }}</td>
          <td>{{ p.row }}</td>
          <td>{{ p.nombre_origen }}</td>
          <td>{{ p.sugerencia|default:"-" }}</td>
          <td class="text-end">{{ p.score }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}
{% endblock %}
