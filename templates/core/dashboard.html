{% extends "base.html" %}

{% block title %}Dashboard - Pollyanas Dolce ERP{% endblock %}
{% block page_title %}Dashboard Ejecutivo{% endblock %}

{% block content %}
<section class="card">
    <div class="card-header">Último Sync de Almacén</div>
    {% if latest_almacen_sync %}
    <div class="sync-summary-grid">
        <div class="sync-item">
            <span class="sync-label">Estatus</span>
            <span class="sync-value">
                {% if latest_almacen_sync.status == "OK" %}
                    <span class="badge bg-success">OK</span>
                {% else %}
                    <span class="badge bg-danger">ERROR</span>
                {% endif %}
            </span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Fecha</span>
            <span class="sync-value">{{ latest_almacen_sync.started_at|date:"Y-m-d H:i" }}</span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Origen</span>
            <span class="sync-value">{{ latest_almacen_sync.get_source_display }}</span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Carpeta / Mes</span>
            <span class="sync-value">
                {{ latest_almacen_sync.folder_name|default:"-" }}
                {% if latest_almacen_sync.target_month %} · {{ latest_almacen_sync.target_month }}{% endif %}
                {% if latest_almacen_sync.fallback_used %} (fallback){% endif %}
            </span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Próximo sync estimado</span>
            <span class="sync-value">
                <span class="badge {{ next_sync_state_class }}">{{ next_sync_state_label }}</span>
                &nbsp;
                {% if auto_sync_enabled %}
                    {% if next_sync_eta %}
                        {{ next_sync_eta|date:"Y-m-d H:i" }} (cada {{ auto_sync_interval_hours }}h)
                    {% else %}
                        Pendiente primer ciclo automático (cada {{ auto_sync_interval_hours }}h)
                    {% endif %}
                {% else %}
                    Auto-sync desactivado
                {% endif %}
            </span>
        </div>
        <div class="sync-item sync-item-full">
            <span class="sync-label">Resultado</span>
            <span class="sync-value">
                Existencias {{ latest_almacen_sync.existencias_updated }} ·
                Movimientos {{ latest_almacen_sync.movimientos_created }} ·
                Sin match {{ latest_almacen_sync.unmatched }}
            </span>
        </div>
    </div>
    {% else %}
    <p style="margin: 0; color: var(--texto-light);">Aún no hay sincronizaciones registradas.</p>
    {% endif %}
    <div class="quick-actions">
        <a href="{% url 'inventario:importar_archivos' %}" class="btn btn-secondary">Ver historial de sync</a>
        {% if can_manage_inventario %}
        <form method="post" action="{% url 'inventario:sync_drive_now' %}" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-primary">Sincronizar ahora</button>
        </form>
        {% endif %}
    </div>
</section>

<div class="kpi-grid">
    <article class="kpi-card">
        <div class="kpi-number">{{ insumos_count }}</div>
        <div class="kpi-label">Insumos Activos</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-success">{{ recetas_count }}</div>
        <div class="kpi-label">Recetas Activas</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-warning">{{ proveedores_count }}</div>
        <div class="kpi-label">Proveedores Vigentes</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-danger">{{ alertas_count }}</div>
        <div class="kpi-label">Alertas de Stock</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-danger">{{ criticos_count }}</div>
        <div class="kpi-label">Críticos (sin stock)</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-warning">{{ bajo_reorden_count }}</div>
        <div class="kpi-label">Bajo Reorden</div>
    </article>
</div>

<section class="card">
    <div class="card-header">Control de Homologación y Matching</div>
    <div class="kpi-grid kpi-mini">
        <article class="kpi-card">
            <div class="kpi-number {% if homologacion_total_pending > 0 %}is-danger{% else %}is-success{% endif %}">
                {{ homologacion_total_pending }}
            </div>
            <div class="kpi-label">Pendientes totales</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if point_pending_total > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ point_pending_total }}
            </div>
            <div class="kpi-label">Pendientes Point</div>
            <div class="muted" style="margin-top:6px;">
                Insumos {{ point_pending_insumos }} · Productos {{ point_pending_productos }} · Proveedores {{ point_pending_proveedores }}
            </div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if recetas_pending_matching_count > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ recetas_pending_matching_count }}
            </div>
            <div class="kpi-label">Líneas recetas por revisar</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if inventario_last_unmatched_count > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ inventario_last_unmatched_count }}
            </div>
            <div class="kpi-label">Sin match último sync almacén</div>
        </article>
    </div>
    <div class="quick-actions" style="margin-top: 10px;">
        <a href="{% url 'maestros:point_pending_review' %}" class="btn btn-secondary">Pendientes Point</a>
        <a href="{% url 'recetas:matching_pendientes' %}" class="btn btn-secondary">Matching Recetas</a>
        <a href="{% url 'inventario:aliases_catalog' %}" class="btn btn-secondary">Aliases Inventario</a>
    </div>
</section>

{% if plan_forecast_semaforo %}
<section class="card">
    <div class="card-header">Desviación Mensual Plan vs Pronóstico ({{ plan_forecast_semaforo.periodo_mes }})</div>
    {% if plan_forecast_semaforo.data_unavailable %}
    <div class="alert alert-info" style="margin-bottom:12px;">
        Datos de plan/pronóstico no disponibles temporalmente en este entorno.
    </div>
    {% endif %}
    <div class="kpi-mini">
        <article class="kpi-card">
            <div class="kpi-label">Semáforo</div>
            <div style="margin-top:8px;"><span class="badge {{ plan_forecast_semaforo.semaforo_badge }}">{{ plan_forecast_semaforo.semaforo_label }}</span></div>
            <div class="muted" style="margin-top:10px;">
                Recetas: {{ plan_forecast_semaforo.recetas_total }} ·
                Con desviación: {{ plan_forecast_semaforo.recetas_con_desviacion }}
            </div>
            <div style="margin-top:10px;">
                <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion' %}?periodo={{ plan_forecast_semaforo.periodo_mes }}">Abrir plan producción</a>
            </div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number">{{ plan_forecast_semaforo.total_plan|floatformat:2 }}</div>
            <div class="kpi-label">Total plan</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number">{{ plan_forecast_semaforo.total_pronostico|floatformat:2 }}</div>
            <div class="kpi-label">Total pronóstico</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if plan_forecast_semaforo.delta_total > 0 %}is-danger{% elif plan_forecast_semaforo.delta_total < 0 %}is-warning{% else %}is-success{% endif %}">
                {{ plan_forecast_semaforo.delta_total|floatformat:2 }}
            </div>
            <div class="kpi-label">
                Delta total
                {% if plan_forecast_semaforo.desviacion_abs_pct is not None %}
                    ({{ plan_forecast_semaforo.desviacion_abs_pct|floatformat:2 }}%)
                {% endif %}
            </div>
        </article>
    </div>
    <div class="table-responsive" style="margin-top:12px;">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Receta</th>
                    <th class="text-end">Plan</th>
                    <th class="text-end">Pronóstico</th>
                    <th class="text-end">Delta</th>
                    <th class="text-end">% Delta</th>
                </tr>
            </thead>
            <tbody>
                {% for row in plan_forecast_semaforo.rows_top %}
                <tr>
                    <td>{{ row.receta }}</td>
                    <td class="text-end">{{ row.plan|floatformat:2 }}</td>
                    <td class="text-end">{{ row.pronostico|floatformat:2 }}</td>
                    <td class="text-end {% if row.delta > 0 %}text-danger{% elif row.delta < 0 %}text-success{% endif %}">{{ row.delta|floatformat:2 }}</td>
                    <td class="text-end">
                        {% if row.delta_pct is not None %}
                            {{ row.delta_pct|floatformat:2 }}%
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-muted">Sin datos de plan/pronóstico para este mes.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<section class="card">
    <div class="card-header">Accesos Operativos</div>
    <div class="quick-actions">
        {% if can_view_maestros %}
            <a href="{% url 'maestros:insumo_list' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 8.5 4.7v8.6L12 21l-8.5-4.7V7.7L12 3Z"/><path d="m3.5 7.7 8.5 4.8 8.5-4.8M12 12.5V21"/></svg>
                </span>
                Catálogo de insumos
            </a>
            <a href="{% url 'maestros:proveedor_list' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20h18"/><path d="M5 20V9l7-5 7 5v11"/><path d="M9 20v-5h6v5"/></svg>
                </span>
                Catálogo de proveedores
            </a>
        {% endif %}
        {% if can_view_compras %}
            <a href="{% url 'compras:solicitudes' %}" class="btn btn-primary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="20" r="1.5"/><circle cx="18" cy="20" r="1.5"/><path d="M3 4h2l2.6 10.5a1 1 0 0 0 1 .8h9.8a1 1 0 0 0 1-.76L21 7H7.2"/></svg>
                </span>
                Flujo de compras
            </a>
        {% endif %}
        {% if can_view_crm %}
            <a href="{% url 'crm:pedidos' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </span>
                CRM pedidos
            </a>
        {% endif %}
        {% if can_view_rrhh %}
            <a href="{% url 'rrhh:empleados' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8h3M21.5 6.5v3"/></svg>
                </span>
                RRHH nómina
            </a>
        {% endif %}
        {% if can_view_inventario %}
            <a href="{% url 'inventario:existencias' %}" class="btn btn-primary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16v12H4z"/><path d="M8 7V5h8v2M8 11h8M8 15h5"/></svg>
                </span>
                Control de inventario
            </a>
        {% endif %}
        {% if can_view_reportes %}
            <a href="{% url 'reportes:costo_receta' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19h16"/><rect x="6" y="11" width="3" height="6" rx="1"/><rect x="11" y="8" width="3" height="9" rx="1"/><rect x="16" y="5" width="3" height="12" rx="1"/></svg>
                </span>
                Reportes ejecutivos
            </a>
        {% endif %}
        {% if can_view_recetas %}
            <a href="{% url 'recetas:recetas_list' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 4h13A1.5 1.5 0 0 1 20 5.5v13a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 4 18.5v-13A1.5 1.5 0 0 1 5.5 4Z"/><path d="M8 9h8M8 13h8M8 17h5"/></svg>
                </span>
                Recetas y costeo
            </a>
        {% endif %}
        {% if can_review_matching %}
            <a href="{% url 'recetas:matching_pendientes' %}" class="btn btn-secondary">
                <span class="btn-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="6"/><path d="m20 20-4.2-4.2"/></svg>
                </span>
                Revisar matching
            </a>
        {% endif %}
    </div>
</section>

<section class="card">
    <div class="card-header">Resumen Fase 1</div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Módulo</th>
                    <th>Estado</th>
                    <th>Alcance sprint</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Maestros</td>
                    <td><span class="badge bg-success">Activo</span></td>
                    <td>ABM básico de insumos y proveedores</td>
                </tr>
                <tr>
                    <td>Recetas</td>
                    <td><span class="badge bg-success">Activo</span></td>
                    <td>Listado, detalle, matching y MRP inicial</td>
                </tr>
                <tr>
                    <td>Compras</td>
                    <td><span class="badge bg-warning">Diseño funcional</span></td>
                    <td>Solicitudes, órdenes y recepciones estructuradas</td>
                </tr>
                <tr>
                    <td>Inventario</td>
                    <td><span class="badge bg-warning">Diseño funcional</span></td>
                    <td>Existencias, movimientos y ajustes listos para integrar lógica</td>
                </tr>
                <tr>
                    <td>Reportes</td>
                    <td><span class="badge bg-warning">Diseño funcional</span></td>
                    <td>Costo receta, consumo y faltantes para visión ejecutiva</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
