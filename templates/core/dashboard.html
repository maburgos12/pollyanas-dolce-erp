{% extends "base.html" %}

{% block title %}Dashboard - Pollyanas Dolce ERP{% endblock %}
{% block page_title %}Dashboard Ejecutivo{% endblock %}

{% block content %}
<section class="card">
    <div class="card-header">칔ltimo Sync de Almac칠n</div>
    {% if latest_almacen_sync %}
    <div class="sync-summary-grid">
        <div class="sync-item">
            <span class="sync-label">Estatus</span>
            <span class="sync-value">
                {% if latest_almacen_sync.status == "OK" %}
                    <span class="badge bg-success">OK</span>
                {% else %}
                    <span class="badge bg-danger">ERROR</span>
                {% endif %}
            </span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Fecha</span>
            <span class="sync-value">{{ latest_almacen_sync.started_at|date:"Y-m-d H:i" }}</span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Origen</span>
            <span class="sync-value">{{ latest_almacen_sync.get_source_display }}</span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Carpeta / Mes</span>
            <span class="sync-value">
                {{ latest_almacen_sync.folder_name|default:"-" }}
                {% if latest_almacen_sync.target_month %} 췅 {{ latest_almacen_sync.target_month }}{% endif %}
                {% if latest_almacen_sync.fallback_used %} (fallback){% endif %}
            </span>
        </div>
        <div class="sync-item">
            <span class="sync-label">Pr칩ximo sync estimado</span>
            <span class="sync-value">
                {% if auto_sync_enabled %}
                    {% if next_sync_eta %}
                        {{ next_sync_eta|date:"Y-m-d H:i" }} (cada {{ auto_sync_interval_hours }}h)
                    {% else %}
                        Pendiente primer ciclo autom치tico (cada {{ auto_sync_interval_hours }}h)
                    {% endif %}
                {% else %}
                    Auto-sync desactivado
                {% endif %}
            </span>
        </div>
        <div class="sync-item sync-item-full">
            <span class="sync-label">Resultado</span>
            <span class="sync-value">
                Existencias {{ latest_almacen_sync.existencias_updated }} 췅
                Movimientos {{ latest_almacen_sync.movimientos_created }} 췅
                Sin match {{ latest_almacen_sync.unmatched }}
            </span>
        </div>
    </div>
    {% else %}
    <p style="margin: 0; color: var(--texto-light);">A칰n no hay sincronizaciones registradas.</p>
    {% endif %}
    <div class="quick-actions">
        <a href="{% url 'inventario:importar_archivos' %}" class="btn btn-secondary">Ver historial de sync</a>
        {% if can_manage_inventario %}
        <form method="post" action="{% url 'inventario:sync_drive_now' %}" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-primary">Sincronizar ahora</button>
        </form>
        {% endif %}
    </div>
</section>

<div class="kpi-grid">
    <article class="kpi-card">
        <div class="kpi-number">{{ insumos_count }}</div>
        <div class="kpi-label">Insumos Activos</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-success">{{ recetas_count }}</div>
        <div class="kpi-label">Recetas Activas</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-warning">{{ proveedores_count }}</div>
        <div class="kpi-label">Proveedores Vigentes</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-danger">{{ alertas_count }}</div>
        <div class="kpi-label">Alertas de Stock</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-danger">{{ criticos_count }}</div>
        <div class="kpi-label">Cr칤ticos (sin stock)</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-warning">{{ bajo_reorden_count }}</div>
        <div class="kpi-label">Bajo Reorden</div>
    </article>
</div>

<section class="card">
    <div class="card-header">Accesos Operativos</div>
    <div class="quick-actions">
        {% if can_view_maestros %}
            <a href="{% url 'maestros:insumo_list' %}" class="btn btn-secondary">游닍 Cat치logo de insumos</a>
            <a href="{% url 'maestros:proveedor_list' %}" class="btn btn-secondary">游끽 Cat치logo de proveedores</a>
        {% endif %}
        {% if can_view_compras %}
            <a href="{% url 'compras:solicitudes' %}" class="btn btn-primary">游 Flujo de compras</a>
        {% endif %}
        {% if can_view_inventario %}
            <a href="{% url 'inventario:existencias' %}" class="btn btn-primary">游닄 Control de inventario</a>
        {% endif %}
        {% if can_view_reportes %}
            <a href="{% url 'reportes:costo_receta' %}" class="btn btn-secondary">游늳 Reportes ejecutivos</a>
        {% endif %}
        {% if can_view_recetas %}
            <a href="{% url 'recetas:recetas_list' %}" class="btn btn-secondary">游븨 Recetas y costeo</a>
        {% endif %}
        {% if can_review_matching %}
            <a href="{% url 'recetas:matching_pendientes' %}" class="btn btn-secondary">游댍 Revisar matching</a>
        {% endif %}
    </div>
</section>

<section class="card">
    <div class="card-header">Resumen Fase 1</div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>M칩dulo</th>
                    <th>Estado</th>
                    <th>Alcance sprint</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Maestros</td>
                    <td><span class="badge bg-success">Activo</span></td>
                    <td>ABM b치sico de insumos y proveedores</td>
                </tr>
                <tr>
                    <td>Recetas</td>
                    <td><span class="badge bg-success">Activo</span></td>
                    <td>Listado, detalle, matching y MRP inicial</td>
                </tr>
                <tr>
                    <td>Compras</td>
                    <td><span class="badge bg-warning">Dise침o funcional</span></td>
                    <td>Solicitudes, 칩rdenes y recepciones estructuradas</td>
                </tr>
                <tr>
                    <td>Inventario</td>
                    <td><span class="badge bg-warning">Dise침o funcional</span></td>
                    <td>Existencias, movimientos y ajustes listos para integrar l칩gica</td>
                </tr>
                <tr>
                    <td>Reportes</td>
                    <td><span class="badge bg-warning">Dise침o funcional</span></td>
                    <td>Costo receta, consumo y faltantes para visi칩n ejecutiva</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
