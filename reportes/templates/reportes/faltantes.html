{% extends "base.html" %}
{% block title %}Reportes - Faltantes{% endblock %}
{% block page_title %}Reportes · Faltantes Críticos{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'reportes:costo_receta' %}">Costo receta</a>
  <a class="module-tab" href="{% url 'reportes:consumo' %}">Consumo</a>
  <a class="module-tab active" href="{% url 'reportes:faltantes' %}">Faltantes</a>
  <a class="module-tab" href="{% url 'reportes:bi' %}">BI</a>
</nav>

<section class="card">
  <div class="card-header">Insumos Debajo de Mínimo</div>
  <div class="toolbar">
    <a href="{% url 'reportes:faltantes' %}" class="btn {% if nivel == 'alerta' %}btn-primary{% else %}btn-secondary{% endif %}">Solo alertas</a>
    <a href="{% url 'reportes:faltantes' %}?nivel=critico" class="btn {% if nivel == 'critico' %}btn-primary{% else %}btn-secondary{% endif %}">Críticos</a>
    <a href="{% url 'reportes:faltantes' %}?nivel=bajo" class="btn {% if nivel == 'bajo' %}btn-primary{% else %}btn-secondary{% endif %}">Bajo mínimo</a>
    <a href="{% url 'reportes:faltantes' %}?nivel=all" class="btn {% if nivel == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">Todos</a>
  </div>
  <div class="kpi-mini">
    <div class="kpi-card"><div class="kpi-number is-danger">{{ criticos_count }}</div><div class="kpi-label">Críticos</div></div>
    <div class="kpi-card"><div class="kpi-number is-warning">{{ bajo_count }}</div><div class="kpi-label">Bajo mínimo</div></div>
    <div class="kpi-card"><div class="kpi-number">{{ alertas_count }}</div><div class="kpi-label">Alertas</div></div>
  </div>
  <div class="toolbar">
    <a class="btn btn-secondary" href="{% url 'reportes:faltantes' %}?nivel={{ nivel }}&export=csv">Descargar CSV</a>
    <a class="btn btn-secondary" href="{% url 'reportes:faltantes' %}?nivel={{ nivel }}&export=xlsx">Descargar Excel</a>
  </div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Insumo</th>
          <th>Unidad</th>
          <th class="text-end">Stock actual</th>
          <th class="text-end">Mínimo</th>
          <th class="text-end">Sugerencia compra</th>
          <th>Criticidad</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td>{{ row.insumo.nombre }}</td>
          <td>{% if row.insumo.unidad_base %}{{ row.insumo.unidad_base.codigo }}{% else %}-{% endif %}</td>
          <td class="text-end">{{ row.stock_actual }}</td>
          <td class="text-end">{{ row.punto_reorden }}</td>
          <td class="text-end">{{ row.sugerencia_compra }}</td>
          <td><span class="badge {{ row.criticidad_badge }}">{{ row.criticidad }}</span></td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-muted">Sin faltantes para el filtro seleccionado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
