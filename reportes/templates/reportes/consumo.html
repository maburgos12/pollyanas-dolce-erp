{% extends "base.html" %}
{% block title %}Reportes - Consumo{% endblock %}
{% block page_title %}Reportes · Consumo por Periodo{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab" href="{% url 'reportes:costo_receta' %}">Costo receta</a>
  <a class="module-tab active" href="{% url 'reportes:consumo' %}">Consumo</a>
  <a class="module-tab" href="{% url 'reportes:faltantes' %}">Faltantes</a>
</nav>

<section class="card">
  <div class="card-header">Consumo de Insumos</div>
  <form method="get" class="d-flex gap-2 mb-3" style="flex-wrap:wrap;">
    <div>
      <label for="date_from">Desde</label>
      <input class="input-field" id="date_from" type="date" name="date_from" value="{{ filters.date_from }}">
    </div>
    <div>
      <label for="date_to">Hasta</label>
      <input class="input-field" id="date_to" type="date" name="date_to" value="{{ filters.date_to }}">
    </div>
    <div>
      <label for="tipo">Tipo</label>
      <select class="input-field" id="tipo" name="tipo">
        <option value="ALL" {% if filters.tipo == "ALL" %}selected{% endif %}>Todos</option>
        <option value="CONSUMO" {% if filters.tipo == "CONSUMO" %}selected{% endif %}>Consumo</option>
        <option value="SALIDA" {% if filters.tipo == "SALIDA" %}selected{% endif %}>Salida</option>
        <option value="ENTRADA" {% if filters.tipo == "ENTRADA" %}selected{% endif %}>Entrada</option>
      </select>
    </div>
    <div class="align-items-end d-flex">
      <button class="btn btn-primary" type="submit">Aplicar filtros</button>
    </div>
  </form>

  <div class="d-flex gap-2 mb-3" style="flex-wrap:wrap;">
    <span class="badge bg-primary">Movimientos: {{ total_movimientos }}</span>
    <span class="badge bg-success">Insumos: {{ total_insumos }}</span>
    <span class="badge bg-warning">Cantidad total: {{ total_cantidad|floatformat:3 }}</span>
  </div>
  <div class="d-flex gap-2 mb-3">
    <a class="btn btn-secondary" href="{% url 'reportes:consumo' %}?date_from={{ filters.date_from }}&date_to={{ filters.date_to }}&tipo={{ filters.tipo }}&export=csv">Descargar CSV</a>
    <a class="btn btn-secondary" href="{% url 'reportes:consumo' %}?date_from={{ filters.date_from }}&date_to={{ filters.date_to }}&tipo={{ filters.tipo }}&export=xlsx">Descargar Excel</a>
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Insumo</th>
          <th class="text-end">Consumo</th>
          <th>Último movimiento</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td>{{ row.insumo__nombre }}</td>
          <td class="text-end">{{ row.cantidad_total|floatformat:3 }}</td>
          <td>{{ row.ultima_fecha|date:"Y-m-d H:i" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="text-muted">Sin movimientos para el periodo seleccionado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
