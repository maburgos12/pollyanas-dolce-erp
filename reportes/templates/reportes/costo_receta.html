{% extends "base.html" %}
{% block title %}Reportes - Costo por receta{% endblock %}
{% block page_title %}Reportes Â· Costo por Receta{% endblock %}

{% block content %}
<nav class="module-tabs">
  <a class="module-tab active" href="{% url 'reportes:costo_receta' %}">Costo receta</a>
  <a class="module-tab" href="{% url 'reportes:consumo' %}">Consumo</a>
  <a class="module-tab" href="{% url 'reportes:faltantes' %}">Faltantes</a>
</nav>

<section class="card">
  <div class="card-header">Costo Estimado por Receta</div>
  <form method="get" class="form-grid-auto mb-3">
    <div>
      <label for="margen">Margen objetivo (%)</label>
      <input class="input-field" id="margen" type="number" min="0" max="500" step="0.01" name="margen" value="{{ margen_pct }}">
    </div>
    <div class="align-items-end d-flex">
      <button class="btn btn-primary" type="submit">Recalcular</button>
    </div>
  </form>
  <div class="kpi-mini">
    <div class="kpi-card"><div class="kpi-number">{{ total_recetas }}</div><div class="kpi-label">Recetas</div></div>
    <div class="kpi-card"><div class="kpi-number is-success">{{ recetas_con_costo }}</div><div class="kpi-label">Con costo</div></div>
    <div class="kpi-card"><div class="kpi-number">{{ total_costo|floatformat:0 }}</div><div class="kpi-label">Costo acumulado</div></div>
  </div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Receta</th>
          <th>Rendimiento</th>
          <th class="text-end">Costo estimado</th>
          <th class="text-end">Costo por Kg</th>
          <th class="text-end">Cobertura de costo</th>
          <th class="text-end">Margen objetivo</th>
          <th class="text-end">Precio sugerido</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td>{{ row.receta.nombre }}</td>
          <td>{% if row.rendimiento_cantidad %}{{ row.rendimiento_cantidad }} {{ row.rendimiento_unidad }}{% else %}-{% endif %}</td>
          <td class="text-end">{{ row.costo_total|floatformat:2 }}</td>
          <td class="text-end">{% if row.costo_por_kg %}{{ row.costo_por_kg|floatformat:2 }}{% else %}-{% endif %}</td>
          <td class="text-end">{{ row.lineas_costeadas }}/{{ row.lineas_total }} ({{ row.cobertura_pct|floatformat:1 }}%)</td>
          <td class="text-end">{{ row.margen_pct|floatformat:2 }}%</td>
          <td class="text-end">{{ row.precio_sugerido|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="text-muted">Sin recetas disponibles para costeo.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
