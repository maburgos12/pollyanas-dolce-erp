{% extends "base.html" %}

{% block title %}Integraciones - API publica{% endblock %}
{% block page_title %}Integraciones · API publica{% endblock %}

{% block content %}
<div class="module-shell integraciones-shell">
    <section class="kpi-mini">
        <article class="kpi-card">
            <div class="kpi-number">{{ clients|length }}</div>
            <div class="kpi-label">Clientes API</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number is-warning">{{ requests_24h }}</div>
            <div class="kpi-label">Requests 24h</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if errors_24h %}is-danger{% else %}is-success{% endif %}">{{ errors_24h }}</div>
            <div class="kpi-label">Errores 24h</div>
        </article>
    </section>

    <section class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="card-header mb-0">Homologacion Point y Match Operativo</div>
            <div class="recipe-actions">
                <a class="btn btn-secondary" href="{% url 'maestros:point_pending_review' %}">Resolver pendientes Point</a>
                <a class="btn btn-outline-primary" href="{% url 'inventario:aliases_catalog' %}">Corregir aliases de almacen</a>
            </div>
        </div>

        <div class="integraciones-homologacion-grid mb-3">
            <article class="kpi-card">
                <div class="kpi-number">{{ integracion_point.insumos.cobertura_pct|floatformat:2 }}%</div>
                <div class="kpi-label">Cobertura Point en insumos</div>
                <div class="muted">{{ integracion_point.insumos.con_codigo_point }}/{{ integracion_point.insumos.activos }}</div>
            </article>
            <article class="kpi-card">
                <div class="kpi-number is-warning">{{ integracion_point.recetas.cobertura_pct|floatformat:2 }}%</div>
                <div class="kpi-label">Cobertura Point en recetas</div>
                <div class="muted">{{ integracion_point.recetas.homologadas }}/{{ integracion_point.recetas.total }}</div>
            </article>
            <article class="kpi-card">
                <div class="kpi-number {% if integracion_point.point_pending.total %}is-danger{% else %}is-success{% endif %}">
                    {{ integracion_point.point_pending.total }}
                </div>
                <div class="kpi-label">Pendientes Point</div>
                <div class="muted">
                    Insumos {{ point_pending_insumo }} · Productos {{ point_pending_producto }} · Proveedores {{ point_pending_proveedor }}
                </div>
            </article>
            <article class="kpi-card">
                <div class="kpi-number {% if integracion_point.inventario.recetas_pending_match %}is-danger{% else %}is-success{% endif %}">
                    {{ integracion_point.inventario.recetas_pending_match }}
                </div>
                <div class="kpi-label">Líneas receta sin match</div>
                <div class="muted">Pendientes de homologación interna</div>
            </article>
            <article class="kpi-card">
                <div class="kpi-number {% if integracion_point.inventario.almacen_pending_preview %}is-warning{% else %}is-success{% endif %}">
                    {{ integracion_point.inventario.almacen_pending_preview }}
                </div>
                <div class="kpi-label">Pendientes recientes almacén</div>
                <div class="muted">
                    {% if integracion_point.inventario.almacen_latest_run_at %}
                    Run {{ integracion_point.inventario.almacen_latest_run_at|date:"Y-m-d H:i" }}
                    {% else %}
                    Sin run registrado
                    {% endif %}
                </div>
            </article>
        </div>

        <div class="card-subtle mb-3">
            <h3 class="integraciones-subtitle">Resolución masiva Point (insumos)</h3>
            <form method="post" class="form-grid-auto">
                {% csrf_token %}
                <input type="hidden" name="action" value="resolve_point_sugerencias_insumos">
                <div class="form-group">
                    <label class="form-label" for="id_auto_score_min">Score mínimo</label>
                    <input
                        id="id_auto_score_min"
                        name="auto_score_min"
                        class="input-field"
                        type="number"
                        min="0"
                        max="100"
                        step="0.1"
                        value="90"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="id_auto_limit">Máximo registros</label>
                    <input
                        id="id_auto_limit"
                        name="auto_limit"
                        class="input-field"
                        type="number"
                        min="1"
                        max="2000"
                        step="1"
                        value="250"
                    >
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <label class="form-label" style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                        <input type="checkbox" name="create_aliases" checked>
                        Crear alias automáticamente
                    </label>
                </div>
                <div class="form-group" style="display:flex;align-items:flex-end;">
                    <button type="submit" class="btn btn-primary w-100">Auto-resolver pendientes de insumos</button>
                </div>
            </form>
            <p class="muted mb-0">
                Aplica sugerencias de nombre con score mínimo, actualiza código/nombre Point del insumo y opcionalmente crea alias.
            </p>
        </div>

        <div class="integraciones-columns">
            <div>
                <h3 class="integraciones-subtitle">Point pendientes (recientes)</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for p in point_pending_recent %}
                            <tr>
                                <td>{{ p.tipo }}</td>
                                <td><code>{{ p.point_codigo|default:"-" }}</code></td>
                                <td>{{ p.point_nombre }}</td>
                                <td>{{ p.fuzzy_score|floatformat:1 }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="muted">Sin pendientes Point.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div>
                <h3 class="integraciones-subtitle">Recetas sin match (recientes)</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Receta</th>
                                <th>Ingrediente</th>
                                <th>Método</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for l in recetas_pending_recent %}
                            <tr>
                                <td>{{ l.receta.nombre }}</td>
                                <td>{{ l.insumo_texto }}</td>
                                <td>{{ l.match_method }}</td>
                                <td>{{ l.match_score|floatformat:1 }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="4" class="muted">Sin líneas pendientes de receta.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div>
            <h3 class="integraciones-subtitle">Almacén pendientes (último run)</h3>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre origen</th>
                            <th>Normalizado</th>
                            <th>Sugerencia</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for r in almacen_pending_preview %}
                        <tr>
                            <td>{{ r.nombre_origen|default:"-" }}</td>
                            <td>{{ r.nombre_normalizado|default:"-" }}</td>
                            <td>{{ r.suggestion|default:"-" }}</td>
                            <td>{{ r.score|default:"0" }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="4" class="muted">Sin pendientes en el último run de almacén.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    {% if last_generated_api_key %}
    <section class="card">
        <div class="card-header">API key generada</div>
        <p class="muted">
            Copia esta llave ahora. Por seguridad se muestra una sola vez.
        </p>
        <div class="integraciones-key-box">{{ last_generated_api_key }}</div>
    </section>
    {% endif %}

    <section class="card">
        <div class="card-header">Nuevo cliente de API</div>
        <form method="post" class="form-grid-auto">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <div class="form-group">
                <label class="form-label" for="id_nombre">Nombre</label>
                <input id="id_nombre" name="nombre" type="text" class="input-field" maxlength="120" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="id_descripcion">Descripcion</label>
                <input id="id_descripcion" name="descripcion" type="text" class="input-field" maxlength="255">
            </div>
            <div class="form-group" style="display:flex;align-items:flex-end;">
                <button type="submit" class="btn btn-primary w-100">Crear cliente</button>
            </div>
        </form>
    </section>

    <section class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="card-header mb-0">Clientes API registrados</div>
            <span class="badge-amarillo">{{ clients|length }} cliente{{ clients|length|pluralize }}</span>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Prefijo</th>
                        <th>Estado</th>
                        <th>Ultimo uso</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                {% for client in clients %}
                    <tr>
                        <td>
                            <strong>{{ client.nombre }}</strong>
                            {% if client.descripcion %}
                            <div class="muted">{{ client.descripcion }}</div>
                            {% endif %}
                        </td>
                        <td><code>{{ client.clave_prefijo }}</code></td>
                        <td>
                            {% if client.activo %}
                            <span class="badge-verde">Activo</span>
                            {% else %}
                            <span class="badge-rojo">Inactivo</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if client.last_used_at %}
                                {{ client.last_used_at|date:"Y-m-d H:i" }}
                            {% else %}
                                <span class="muted">Sin uso</span>
                            {% endif %}
                        </td>
                        <td>{{ client.created_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            <div class="recipe-actions">
                                <form method="post" class="inline-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="rotate">
                                    <input type="hidden" name="client_id" value="{{ client.id }}">
                                    <button type="submit" class="btn btn-secondary">Rotar key</button>
                                </form>
                                <form method="post" class="inline-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="toggle">
                                    <input type="hidden" name="client_id" value="{{ client.id }}">
                                    {% if client.activo %}
                                    <button type="submit" class="btn btn-danger">Desactivar</button>
                                    {% else %}
                                    <button type="submit" class="btn btn-success">Activar</button>
                                    {% endif %}
                                </form>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="muted">Sin clientes API registrados.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <div class="card-header">Top consumo API (ultimas 24h)</div>
        {% if top_clients_24h %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Requests</th>
                        <th>Errores</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in top_clients_24h %}
                    <tr>
                        <td>{{ row.client__nombre }}</td>
                        <td>{{ row.total }}</td>
                        <td>
                            {% if row.errores %}
                            <span class="badge-rojo">{{ row.errores }}</span>
                            {% else %}
                            <span class="badge-verde">0</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="muted">No hay requests en las ultimas 24 horas.</p>
        {% endif %}
    </section>

    <section class="card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="card-header mb-0">Log de accesos recientes</div>
            <a
                class="btn btn-outline-primary"
                href="?client={{ filter_client_id }}&status={{ filter_status }}&q={{ filter_q|urlencode }}&export=csv"
            >
                Exportar CSV
            </a>
        </div>
        <form method="get" class="form-grid-auto mb-3">
            <div class="form-group">
                <label class="form-label" for="id_client">Cliente</label>
                <select id="id_client" name="client" class="form-select">
                    <option value="">Todos</option>
                    {% for c in clients %}
                    <option value="{{ c.id }}" {% if filter_client_id == c.id|stringformat:"s" %}selected{% endif %}>
                        {{ c.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="id_status">Status</label>
                <select id="id_status" name="status" class="form-select">
                    <option value="all" {% if filter_status == "all" %}selected{% endif %}>Todos</option>
                    <option value="ok" {% if filter_status == "ok" %}selected{% endif %}>Solo OK (&lt;400)</option>
                    <option value="error" {% if filter_status == "error" %}selected{% endif %}>Solo error (&gt;=400)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="id_q">Endpoint contiene</label>
                <input id="id_q" name="q" class="input-field" type="text" value="{{ filter_q }}">
            </div>
            <div class="form-group" style="display:flex;align-items:flex-end;">
                <button class="btn btn-primary w-100" type="submit">Aplicar filtros</button>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Metodo</th>
                        <th>Endpoint</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in logs %}
                    <tr>
                        <td>{{ row.created_at|date:"Y-m-d H:i:s" }}</td>
                        <td>{{ row.client.nombre }}</td>
                        <td><code>{{ row.method }}</code></td>
                        <td><code>{{ row.endpoint }}</code></td>
                        <td>
                            {% if row.status_code >= 400 %}
                            <span class="badge-rojo">{{ row.status_code }}</span>
                            {% else %}
                            <span class="badge-verde">{{ row.status_code }}</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="muted">Sin logs por el momento.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}
