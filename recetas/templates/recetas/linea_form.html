{% extends "base.html" %}
{% block title %}{% if linea %}Editar línea{% else %}Nueva línea{% endif %}{% endblock %}
{% block content %}
<div class="card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">{% if linea %}Editar línea{% else %}Nueva línea{% endif %}</h3>
      <div class="text-muted">Receta: {{ receta.nombre }}</div>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'recetas:receta_detail' receta.id %}">Volver a receta</a>
  </div>

  <form method="post">
    {% csrf_token %}
    <div class="kpi-grid">
      <div class="form-group">
        <label for="posicion">Posición</label>
        <input id="posicion" class="form-control" type="number" min="1" name="posicion" value="{{ linea.posicion|default:'' }}">
      </div>
      <div class="form-group">
        <label for="cantidad">Cantidad</label>
        <input id="cantidad" class="form-control" type="number" step="0.000001" min="0" name="cantidad" value="{{ linea.cantidad|default:'' }}">
      </div>
      <div class="form-group">
        <label for="costo_linea_excel">Costo línea excel</label>
        <input id="costo_linea_excel" class="form-control" type="number" step="0.000001" min="0" name="costo_linea_excel" value="{{ linea.costo_linea_excel|default:'' }}">
      </div>
    </div>

    <div class="kpi-grid">
      <div class="form-group">
        <label for="insumo_texto">Ingrediente (texto)</label>
        <input id="insumo_texto" class="form-control" type="text" name="insumo_texto" value="{{ linea.insumo_texto|default:'' }}" required>
      </div>
      <div class="form-group">
        <label for="etapa">Etapa / Sección</label>
        <input id="etapa" class="form-control" type="text" name="etapa" value="{{ linea.etapa|default:'' }}" placeholder="Ej. Dream Whip, Fresa fresca">
      </div>
      <div class="form-group">
        <label for="unidad_texto">Unidad (texto)</label>
        <input id="unidad_texto" class="form-control" type="text" name="unidad_texto" value="{{ linea.unidad_texto|default:'' }}">
      </div>
    </div>

    <div class="kpi-grid">
      <div class="form-group">
        <label for="tipo_linea">Tipo de línea</label>
        <select id="tipo_linea" class="form-select" name="tipo_linea">
          {% for value, label in linea_tipo_choices %}
          <option value="{{ value }}"
            {% if linea %}
              {% if linea.tipo_linea == value %}selected{% endif %}
            {% else %}
              {% if value == "NORMAL" %}selected{% endif %}
            {% endif %}
          >{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="form-group">
        <label for="insumo_autocomplete">Buscar insumo (autocompletar)</label>
        <input id="insumo_autocomplete" class="form-control" type="text" placeholder="Escribe y presiona Enter..." autocomplete="off">
        <div id="insumo_autocomplete_suggestions" class="autocomplete-suggestions" role="listbox" aria-label="Sugerencias de insumo"></div>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="form-group">
        <label for="insumo_id">Insumo ligado</label>
        <select id="insumo_id" class="form-select" name="insumo_id" style="display:none;">
          <option value="">Sin ligar</option>
          <optgroup label="Insumos internos (producidos)">
            {% for i in insumos %}
              {% if i.codigo|default:""|slice:":16" == "DERIVADO:RECETA:" %}
              <option
                value="{{ i.id }}"
                data-origin="INTERNO"
                data-unidad-id="{% if i.unidad_base_id %}{{ i.unidad_base_id }}{% endif %}"
                data-unidad-codigo="{% if i.unidad_base %}{{ i.unidad_base.codigo }}{% endif %}"
                data-costo-unitario="{% if i.latest_costo_unitario %}{{ i.latest_costo_unitario }}{% endif %}"
                {% if linea.insumo_id == i.id %}selected{% endif %}
              >{{ i.nombre }} [Interno]</option>
              {% endif %}
            {% endfor %}
          </optgroup>
          <optgroup label="Materia prima">
            {% for i in insumos %}
              {% if i.codigo|default:""|slice:":16" != "DERIVADO:RECETA:" %}
              <option
                value="{{ i.id }}"
                data-origin="MATERIA_PRIMA"
                data-unidad-id="{% if i.unidad_base_id %}{{ i.unidad_base_id }}{% endif %}"
                data-unidad-codigo="{% if i.unidad_base %}{{ i.unidad_base.codigo }}{% endif %}"
                data-costo-unitario="{% if i.latest_costo_unitario %}{{ i.latest_costo_unitario }}{% endif %}"
                {% if linea.insumo_id == i.id %}selected{% endif %}
              >{{ i.nombre }} [Materia prima]</option>
              {% endif %}
            {% endfor %}
          </optgroup>
        </select>
        <div class="text-muted mt-1">
          Escribe para buscar, presiona Enter para tomar la mejor coincidencia.
        </div>
      </div>
      <div class="form-group">
        <label for="unidad_id">Unidad normalizada</label>
        <select id="unidad_id" class="form-select" name="unidad_id">
          <option value="">Sin unidad</option>
          {% for u in unidades %}
          <option value="{{ u.id }}" {% if linea.unidad_id == u.id %}selected{% endif %}>{{ u.codigo }} - {{ u.nombre }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="form-group">
        <label for="insumo_origen">Origen de insumo</label>
        <input id="insumo_origen" class="form-control" type="text" value="-" readonly>
      </div>
      <div class="form-group">
        <label for="costo_unitario_preview">Costo unitario vigente</label>
        <input id="costo_unitario_preview" class="form-control" type="text" value="-" readonly>
      </div>
      <div class="form-group">
        <label for="costo_estimado_preview">Costo estimado (cantidad x costo unitario)</label>
        <input id="costo_estimado_preview" class="form-control" type="text" value="-" readonly>
      </div>
    </div>

    <div class="recipe-actions">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a class="btn btn-secondary" href="{% url 'recetas:receta_detail' receta.id %}">Cancelar</a>
    </div>
  </form>
</div>

<script>
(function () {
  const insumoSelect = document.getElementById("insumo_id");
  const insumoAutocomplete = document.getElementById("insumo_autocomplete");
  const suggestionsBox = document.getElementById("insumo_autocomplete_suggestions");
  const unidadSelect = document.getElementById("unidad_id");
  const unidadTexto = document.getElementById("unidad_texto");
  const cantidadInput = document.getElementById("cantidad");
  const origenInput = document.getElementById("insumo_origen");
  const costoUnitarioInput = document.getElementById("costo_unitario_preview");
  const costoEstimadoInput = document.getElementById("costo_estimado_preview");
  const insumoOptions = Array.from(insumoSelect.querySelectorAll("option"))
    .filter((opt) => !!opt.value)
    .map((opt) => ({ value: opt.value, label: opt.textContent.trim() }));
  let currentSuggestions = [];
  let highlightedSuggestionIndex = -1;

  function toNum(v) {
    if (v === null || v === undefined) return NaN;
    const n = parseFloat(String(v).replace(",", "."));
    return Number.isFinite(n) ? n : NaN;
  }

  function formatMoney(n) {
    return "$" + n.toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function normalizeText(v) {
    return String(v || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function suggestionsFor(query) {
    const q = normalizeText(query);
    if (!q) return [];
    return insumoOptions
      .map((item) => {
        const norm = normalizeText(item.label);
        const idx = norm.indexOf(q);
        return { ...item, idx };
      })
      .filter((item) => item.idx >= 0)
      .sort((a, b) => (a.idx - b.idx) || (a.label.length - b.label.length))
      .slice(0, 12);
  }

  function selectInsumoByValue(value) {
    if (!value) return;
    insumoSelect.value = String(value);
    const option = insumoSelect.options[insumoSelect.selectedIndex];
    if (option && option.value) {
      insumoAutocomplete.value = option.textContent.trim();
    }
    clearSuggestions();
    recalc();
    if (cantidadInput) {
      cantidadInput.focus();
      cantidadInput.select();
    }
  }

  function renderSuggestions() {
    suggestionsBox.innerHTML = "";
    if (!currentSuggestions.length) {
      highlightedSuggestionIndex = -1;
      return;
    }
    currentSuggestions.forEach((item, idx) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "autocomplete-item";
      btn.setAttribute("role", "option");
      btn.setAttribute("aria-selected", idx === highlightedSuggestionIndex ? "true" : "false");
      btn.dataset.value = item.value;
      btn.dataset.idx = String(idx);
      btn.textContent = item.label;
      btn.addEventListener("click", () => {
        selectInsumoByValue(item.value);
      });
      if (idx === highlightedSuggestionIndex) {
        btn.classList.add("is-active");
      } else if (idx === 0) {
        btn.classList.add("is-best-match");
      }
      suggestionsBox.appendChild(btn);
    });
  }

  function clearSuggestions() {
    currentSuggestions = [];
    highlightedSuggestionIndex = -1;
    suggestionsBox.innerHTML = "";
  }

  function setHighlightedIndex(index) {
    if (!currentSuggestions.length) {
      highlightedSuggestionIndex = -1;
      return;
    }
    const len = currentSuggestions.length;
    highlightedSuggestionIndex = ((index % len) + len) % len;
    renderSuggestions();
    const active = suggestionsBox.querySelector('.autocomplete-item.is-active');
    if (active) {
      active.scrollIntoView({ block: "nearest" });
    }
  }

  function updateSuggestions() {
    currentSuggestions = suggestionsFor(insumoAutocomplete.value);
    highlightedSuggestionIndex = currentSuggestions.length ? 0 : -1;
    renderSuggestions();
  }

  function recalc() {
    const option = insumoSelect.options[insumoSelect.selectedIndex];
    if (!option || !option.value) {
      origenInput.value = "-";
      costoUnitarioInput.value = "-";
      costoEstimadoInput.value = "-";
      return;
    }
    const origin = option.dataset.origin || "-";
    const unitId = option.dataset.unidadId || "";
    const unitCode = option.dataset.unidadCodigo || "";
    const unitCost = toNum(option.dataset.costoUnitario || "");
    const qty = toNum(cantidadInput.value);

    origenInput.value = origin === "INTERNO" ? "Insumo interno (producido)" : "Materia prima";

    if (unitId) {
      unidadSelect.value = unitId;
    }
    if (unitCode) {
      unidadTexto.value = unitCode;
    }

    if (Number.isFinite(unitCost) && unitCost > 0) {
      costoUnitarioInput.value = formatMoney(unitCost);
      if (Number.isFinite(qty) && qty > 0) {
        costoEstimadoInput.value = formatMoney(unitCost * qty);
      } else {
        costoEstimadoInput.value = "-";
      }
    } else {
      costoUnitarioInput.value = "-";
      costoEstimadoInput.value = "-";
    }
  }

  insumoSelect.addEventListener("change", recalc);
  cantidadInput.addEventListener("input", recalc);
  insumoAutocomplete.addEventListener("input", updateSuggestions);
  insumoAutocomplete.addEventListener("keydown", (ev) => {
    if (ev.key === "ArrowDown") {
      ev.preventDefault();
      if (!currentSuggestions.length) {
        updateSuggestions();
      }
      if (currentSuggestions.length) {
        setHighlightedIndex(highlightedSuggestionIndex + 1);
      }
      return;
    }
    if (ev.key === "ArrowUp") {
      ev.preventDefault();
      if (!currentSuggestions.length) {
        updateSuggestions();
      }
      if (currentSuggestions.length) {
        setHighlightedIndex(highlightedSuggestionIndex - 1);
      }
      return;
    }
    if (ev.key === "Escape") {
      ev.preventDefault();
      clearSuggestions();
      return;
    }
    if (ev.key === "Enter") {
      ev.preventDefault();
      if (currentSuggestions.length > 0) {
        const pickIndex = highlightedSuggestionIndex >= 0 ? highlightedSuggestionIndex : 0;
        selectInsumoByValue(currentSuggestions[pickIndex].value);
        return;
      }
      const exact = insumoOptions.find((item) => normalizeText(item.label) === normalizeText(insumoAutocomplete.value));
      if (exact) {
        selectInsumoByValue(exact.value);
      }
    }
  });
  document.addEventListener("click", (ev) => {
    if (!suggestionsBox.contains(ev.target) && ev.target !== insumoAutocomplete) {
      clearSuggestions();
    }
  });

  // Si ya hay un insumo seleccionado (pantalla de edición), mostrarlo en el input.
  if (insumoSelect.value) {
    selectInsumoByValue(insumoSelect.value);
  }

  recalc();
})();
</script>
<style>
.autocomplete-suggestions {
  position: relative;
  z-index: 5;
  margin-top: 8px;
  max-height: 260px;
  overflow-y: auto;
  border-radius: 8px;
}
.autocomplete-item {
  display: block;
  width: 100%;
  text-align: left;
  border: 1px solid #f0d0dc;
  background: #fff;
  color: #3d2b2b;
  padding: 8px 10px;
  font-size: 13px;
}
.autocomplete-item + .autocomplete-item {
  border-top: 0;
}
.autocomplete-item.is-best-match {
  background: #f8e8ee;
}
.autocomplete-item.is-active {
  background: #f0d0dc;
  border-color: #e8b4c8;
}
</style>
{% endblock %}
