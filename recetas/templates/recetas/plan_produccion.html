{% extends "base.html" %}
{% block title %}Plan de Producción{% endblock %}
{% block page_title %}Recetas · Plan de Producción{% endblock %}
{% block content %}
<div class="module-shell plan-produccion-shell">
<div class="card">
  <div class="card-header">Plan de Producción</div>
  <p class="muted mb-3">Define qué productos vas a fabricar y el sistema calcula automáticamente insumos requeridos y costo total estimado.</p>

  <form class="form-grid-2" method="post" action="{% url 'recetas:plan_produccion_create' %}">
    {% csrf_token %}
    <div class="form-group">
      <label class="form-label">Nombre del plan</label>
      <input class="form-control" name="nombre" required placeholder="Ej. Producción Semana 8">
    </div>
    <div class="form-group">
      <label class="form-label">Fecha producción</label>
      <input class="form-control" type="date" name="fecha_produccion">
    </div>
    <div class="form-group full">
      <label class="form-label">Notas</label>
      <input class="form-control" name="notas" placeholder="Opcional">
    </div>
    <div class="form-group full">
      <button class="btn btn-primary" type="submit">Crear plan</button>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header">Pronósticos de Venta (CSV/XLSX)</div>
  <p class="muted mb-3">
    Carga pronósticos por receta para alimentar la comparación Plan vs Pronóstico.
    Periodo actual: <strong>{{ periodo_pronostico_default }}</strong> ·
    Registros: <strong>{{ pronosticos_periodo_count }}</strong> ·
    Total: <strong>{{ pronosticos_periodo_total|floatformat:2 }}</strong>
  </p>
  {% if pronosticos_unavailable %}
  <div class="alert alert-info" style="margin-bottom: 12px;">
    No se pudo leer la tabla de pronósticos en este entorno. Ejecuta migraciones para habilitar este bloque.
  </div>
  {% endif %}
  <div class="toolbar mb-2">
    <a class="btn btn-secondary" href="{% url 'recetas:pronosticos_plantilla' %}?format=xlsx">Descargar plantilla XLSX</a>
    <a class="btn btn-secondary" href="{% url 'recetas:pronosticos_plantilla' %}?format=csv">Descargar plantilla CSV</a>
  </div>
  <form class="form-grid-auto" method="post" action="{% url 'recetas:pronosticos_importar' %}" enctype="multipart/form-data">
    {% csrf_token %}
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Archivo pronóstico</label>
      <input class="form-control" type="file" name="archivo" accept=".xlsx,.xlsm,.csv" required>
    </div>
    <div class="form-group">
      <label class="form-label">Periodo default</label>
      <input class="form-control" type="month" name="periodo_default" value="{{ periodo_pronostico_default }}">
    </div>
    <div class="form-group">
      <label class="form-label">Modo</label>
      <select class="form-select" name="modo">
        <option value="replace" selected>Reemplazar receta+periodo</option>
        <option value="accumulate">Acumular cantidad</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Fuente</label>
      <input class="form-control" name="fuente" value="UI_PRONOSTICO" maxlength="40">
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Importar pronósticos</button>
    </div>
  </form>
  <p class="muted mb-0">Columnas sugeridas: <code>receta</code>, <code>codigo_point</code>, <code>periodo</code> (YYYY-MM), <code>cantidad</code>.</p>
  <hr>
  <div class="card-header" style="margin-top:8px;">Historial de Ventas (Base Estadística)</div>
  <p class="muted mb-2">
    Registros: <strong>{{ ventas_historicas_count }}</strong> ·
    Cantidad acumulada: <strong>{{ ventas_historicas_total|floatformat:2 }}</strong> ·
    Última fecha: <strong>{% if ventas_hist_fecha_max %}{{ ventas_hist_fecha_max }}{% else %}-{% endif %}</strong>
  </p>
  {% if ventas_historicas_unavailable %}
  <div class="alert alert-info" style="margin-bottom: 12px;">
    La tabla de historial de ventas no está disponible en este entorno; ejecuta migraciones para habilitarla.
  </div>
  {% endif %}
  <div class="toolbar mb-2">
    <a class="btn btn-secondary" href="{% url 'recetas:ventas_historicas_plantilla' %}?format=xlsx">Plantilla ventas XLSX</a>
    <a class="btn btn-secondary" href="{% url 'recetas:ventas_historicas_plantilla' %}?format=csv">Plantilla ventas CSV</a>
  </div>
  <form class="form-grid-auto mb-2" method="post" action="{% url 'recetas:ventas_historicas_importar' %}" enctype="multipart/form-data">
    {% csrf_token %}
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Archivo ventas</label>
      <input class="form-control" type="file" name="archivo" accept=".xlsx,.xlsm,.csv" required>
    </div>
    <div class="form-group">
      <label class="form-label">Sucursal default (opcional)</label>
      <select class="form-select" name="sucursal_default_id">
        <option value="">Sin default</option>
        {% for s in sucursales %}
        <option value="{{ s.id }}">{{ s.codigo }} - {{ s.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Modo</label>
      <select class="form-select" name="modo">
        <option value="replace" selected>Reemplazar receta+sucursal+fecha</option>
        <option value="accumulate">Acumular</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Fuente</label>
      <input class="form-control" name="fuente" value="UI_VENTAS" maxlength="40">
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Importar historial</button>
    </div>
  </form>
  <p class="muted mb-0">Columnas sugeridas: <code>receta</code>, <code>codigo_point</code>, <code>sucursal_codigo</code>, <code>fecha</code>, <code>cantidad</code>.</p>
  <hr>
  <div class="card-header" style="margin-top:8px;">Solicitud de Ventas (por Sucursal)</div>
  <p class="muted mb-2">
    Registros periodo {{ periodo_pronostico_default }}:
    <strong>{{ solicitudes_venta_count }}</strong> ·
    Cantidad solicitada: <strong>{{ solicitudes_venta_total|floatformat:2 }}</strong> ·
    Última fecha: <strong>{% if solicitudes_venta_fecha_max %}{{ solicitudes_venta_fecha_max }}{% else %}-{% endif %}</strong>
  </p>
  {% if solicitudes_venta_unavailable %}
  <div class="alert alert-info" style="margin-bottom: 12px;">
    La tabla de solicitudes de ventas no está disponible en este entorno; ejecuta migraciones para habilitarla.
  </div>
  {% endif %}
  <div class="toolbar mb-2">
    <a class="btn btn-secondary" href="{% url 'recetas:solicitud_ventas_plantilla' %}?format=xlsx">Plantilla solicitud XLSX</a>
    <a class="btn btn-secondary" href="{% url 'recetas:solicitud_ventas_plantilla' %}?format=csv">Plantilla solicitud CSV</a>
  </div>
  <form class="form-grid-auto mb-2" method="post" action="{% url 'recetas:solicitud_ventas_guardar' %}">
    {% csrf_token %}
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Receta</label>
      <select class="form-select" name="receta_id" required>
        <option value="">Selecciona...</option>
        {% for r in recetas_disponibles %}
          <option value="{{ r.id }}">{{ r.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Sucursal</label>
      <select class="form-select" name="sucursal_id">
        <option value="">Todas</option>
        {% for s in sucursales %}
        <option value="{{ s.id }}">{{ s.codigo }} - {{ s.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Alcance</label>
      <select class="form-select" name="alcance">
        <option value="mes" selected>Mes</option>
        <option value="semana">Semana</option>
        <option value="fin_semana">Fin de semana</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Periodo (si alcance = mes)</label>
      <input class="form-control" type="month" name="periodo" value="{{ periodo_pronostico_default }}">
    </div>
    <div class="form-group">
      <label class="form-label">Fecha base (semana/fin semana)</label>
      <input class="form-control" type="date" name="fecha_base" value="{{ fecha_base_estadistica }}">
    </div>
    <div class="form-group">
      <label class="form-label">Cantidad solicitada</label>
      <input class="form-control" type="number" min="0.001" step="0.001" name="cantidad" required>
    </div>
    <div class="form-group">
      <label class="form-label">Fuente</label>
      <input class="form-control" name="fuente" value="UI_SOL_VENTAS" maxlength="40">
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Guardar solicitud ventas</button>
    </div>
  </form>
  <form class="form-grid-auto mb-2" method="post" action="{% url 'recetas:solicitud_ventas_importar' %}" enctype="multipart/form-data">
    {% csrf_token %}
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Archivo solicitud</label>
      <input class="form-control" type="file" name="archivo" accept=".xlsx,.xlsm,.csv" required>
    </div>
    <div class="form-group">
      <label class="form-label">Alcance default</label>
      <select class="form-select" name="alcance_default">
        <option value="mes" selected>Mes</option>
        <option value="semana">Semana</option>
        <option value="fin_semana">Fin de semana</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Periodo default</label>
      <input class="form-control" type="month" name="periodo_default" value="{{ periodo_pronostico_default }}">
    </div>
    <div class="form-group">
      <label class="form-label">Fecha base default</label>
      <input class="form-control" type="date" name="fecha_base_default" value="{{ fecha_base_estadistica }}">
    </div>
    <div class="form-group">
      <label class="form-label">Sucursal default (opcional)</label>
      <select class="form-select" name="sucursal_default_id">
        <option value="">Sin default</option>
        {% for s in sucursales %}
        <option value="{{ s.id }}">{{ s.codigo }} - {{ s.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Modo</label>
      <select class="form-select" name="modo">
        <option value="replace" selected>Reemplazar receta+sucursal+rango</option>
        <option value="accumulate">Acumular cantidad</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Fuente</label>
      <input class="form-control" name="fuente" value="UI_SOL_VENTAS" maxlength="40">
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Importar solicitudes ventas</button>
    </div>
  </form>
  <p class="muted mb-0">
    Columnas sugeridas: <code>receta</code>, <code>codigo_point</code>, <code>sucursal_codigo</code>, <code>alcance</code>, <code>periodo</code>, <code>fecha_inicio</code>, <code>fecha_fin</code>, <code>cantidad</code>.
  </p>
  <hr>
  <div class="card-header" style="margin-top:8px;">Pronóstico Estadístico desde Historial</div>
  <p class="muted mb-2">
    Calcula temporalidad por sucursal y recomienda si Ventas debe subir/bajar solicitud.
    Alcances soportados: mes, semana o fin de semana.
  </p>
  <form class="form-grid-auto" method="post" action="{% url 'recetas:pronostico_estadistico_desde_historial' %}">
    {% csrf_token %}
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Alcance</label>
      <select class="form-select" name="alcance">
        <option value="mes" {% if alcance_estadistico == "mes" %}selected{% endif %}>Mes</option>
        <option value="semana" {% if alcance_estadistico == "semana" %}selected{% endif %}>Semana (lun-dom)</option>
        <option value="fin_semana" {% if alcance_estadistico == "fin_semana" %}selected{% endif %}>Fin de semana</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Periodo mensual</label>
      <input class="form-control" type="month" name="periodo" value="{{ periodo_pronostico_default }}">
    </div>
    <div class="form-group">
      <label class="form-label">Fecha base (semana / fin semana)</label>
      <input class="form-control" type="date" name="fecha_base" value="{{ fecha_base_estadistica }}">
    </div>
    <div class="form-group">
      <label class="form-label">Sucursal</label>
      <select class="form-select" name="sucursal_id">
        <option value="">Todas</option>
        {% for s in sucursales %}
        <option value="{{ s.id }}">{{ s.codigo }} - {{ s.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Ajuste seguridad %</label>
      <input class="form-control" type="number" step="0.1" name="safety_pct" value="0">
    </div>
    <div class="form-group">
      <label class="form-label">Confianza mínima %</label>
      <input class="form-control" type="number" step="0.1" min="0" max="100" name="min_confianza_pct" value="{{ min_confianza_default|default:'0' }}">
    </div>
    <div class="form-group">
      <label class="form-label">Escenario</label>
      <select class="form-select" name="escenario">
        <option value="base" {% if forecast_run_escenario_default == "base" %}selected{% endif %}>Base (forecast)</option>
        <option value="bajo" {% if forecast_run_escenario_default == "bajo" %}selected{% endif %}>Conservador (banda baja)</option>
        <option value="alto" {% if forecast_run_escenario_default == "alto" %}selected{% endif %}>Agresivo (banda alta)</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Backtest ventanas</label>
      <input class="form-control" type="number" name="backtest_periods" min="1" max="12" value="{{ backtest_periods|default:'3' }}">
    </div>
    <div class="form-group">
      <label class="form-label">Backtest top errores</label>
      <input class="form-control" type="number" name="backtest_top" min="1" max="30" value="{{ backtest_top|default:'10' }}">
    </div>
    <div class="form-group">
      <label class="form-label">Alcance recetas</label>
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="incluir_preparaciones" value="1">
        <span>Incluir preparaciones internas</span>
      </label>
    </div>
    <div class="form-group full">
      <div class="toolbar">
        <button class="btn btn-secondary" type="submit" name="run_mode" value="preview">Previsualizar</button>
        <button class="btn btn-secondary" type="submit" name="run_mode" value="backtest">Ejecutar backtest</button>
        <button class="btn btn-primary" type="submit" name="run_mode" value="apply_pronostico">Aplicar a pronóstico mensual</button>
        <button class="btn btn-primary" type="submit" name="run_mode" value="crear_plan">Crear plan estadístico</button>
        <button class="btn btn-success" type="submit" name="run_mode" value="aplicar_y_plan">Aplicar + Crear plan</button>
      </div>
    </div>
  </form>
  {% if forecast_preview %}
  <div class="card" style="margin-top:12px;">
    <div class="card-header">Preview estadístico · {{ forecast_preview.alcance|upper }} · {{ forecast_preview.sucursal_nombre }}</div>
    <p class="muted mb-2">
      Rango: {{ forecast_preview.target_start }} a {{ forecast_preview.target_end }} ·
      Recetas: {{ forecast_preview.totals.recetas_count }} ·
      Confianza mínima: {{ forecast_preview.min_confianza_pct|default:0|floatformat:1 }}% ·
      Forecast total: {{ forecast_preview.totals.forecast_total|floatformat:2 }} ·
      Banda baja: {{ forecast_preview.totals.forecast_low_total|floatformat:2 }} ·
      Banda alta: {{ forecast_preview.totals.forecast_high_total|floatformat:2 }} ·
      Pronóstico actual: {{ forecast_preview.totals.pronostico_total|floatformat:2 }} ·
      Delta: {{ forecast_preview.totals.delta_total|floatformat:2 }}
    </p>
    <div class="toolbar mb-2">
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_preview_export' %}?format=csv&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar preview CSV</a>
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_preview_export' %}?format=xlsx&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar preview XLSX</a>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Receta</th>
            <th class="text-end">Forecast</th>
            <th class="text-end">Banda baja</th>
            <th class="text-end">Banda alta</th>
            <th class="text-end">Pronóstico actual</th>
            <th class="text-end">Delta</th>
            <th>Recomendación</th>
            <th class="text-end">Confianza</th>
            <th class="text-end">Observaciones</th>
          </tr>
        </thead>
        <tbody>
          {% for row in forecast_preview.rows %}
          <tr>
            <td>{{ row.receta }}</td>
            <td class="text-end">{{ row.forecast_qty|floatformat:2 }}</td>
            <td class="text-end">{{ row.forecast_low|floatformat:2 }}</td>
            <td class="text-end">{{ row.forecast_high|floatformat:2 }}</td>
            <td class="text-end">{{ row.pronostico_actual|floatformat:2 }}</td>
            <td class="text-end">{{ row.delta|floatformat:2 }}</td>
            <td>
              {% if row.recomendacion == "SUBIR" %}
              <span class="badge badge-verde">Subir</span>
              {% elif row.recomendacion == "BAJAR" %}
              <span class="badge badge-rojo">Bajar</span>
              {% else %}
              <span class="badge badge-amarillo">Mantener</span>
              {% endif %}
            </td>
            <td class="text-end">{{ row.confianza|floatformat:1 }}%</td>
            <td class="text-end">{{ row.observaciones }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-muted">Sin filas para el filtro actual.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  {% if forecast_backtest %}
  <div class="card" style="margin-top:12px;">
    <div class="card-header">Backtest estadístico · {{ forecast_backtest.scope.alcance|upper }} · {{ forecast_backtest.scope.sucursal_nombre }}</div>
    <p class="muted mb-2">
      Ventanas: {{ forecast_backtest.totals.windows_evaluated }} ·
      Escenario: {{ forecast_backtest.scope.escenario|default:'base'|upper }} ·
      Confianza mínima: {{ forecast_backtest.scope.min_confianza_pct|default:0|floatformat:1 }}% ·
      Forecast total: {{ forecast_backtest.totals.forecast_total|floatformat:2 }} ·
      Real total: {{ forecast_backtest.totals.actual_total|floatformat:2 }} ·
      Bias: {{ forecast_backtest.totals.bias_total|floatformat:2 }} ·
      MAE: {{ forecast_backtest.totals.mae_promedio|floatformat:2 }} ·
      MAPE: {% if forecast_backtest.totals.mape_promedio is not None %}{{ forecast_backtest.totals.mape_promedio|floatformat:1 }}%{% else %}-{% endif %}
    </p>
    <div class="toolbar mb-2">
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_backtest_export' %}?format=csv&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar backtest CSV</a>
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_backtest_export' %}?format=xlsx&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar backtest XLSX</a>
    </div>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Ventana</th>
            <th class="text-end">Recetas</th>
            <th class="text-end">Forecast</th>
            <th class="text-end">Real</th>
            <th class="text-end">Bias</th>
            <th class="text-end">MAE</th>
            <th class="text-end">MAPE</th>
          </tr>
        </thead>
        <tbody>
          {% for w in forecast_backtest.windows %}
          <tr>
            <td>{{ w.window_start }} a {{ w.window_end }}</td>
            <td class="text-end">{{ w.recetas_count }}</td>
            <td class="text-end">{{ w.forecast_total|floatformat:2 }}</td>
            <td class="text-end">{{ w.actual_total|floatformat:2 }}</td>
            <td class="text-end">{{ w.bias_total|floatformat:2 }}</td>
            <td class="text-end">{{ w.mae|floatformat:2 }}</td>
            <td class="text-end">{% if w.mape is not None %}{{ w.mape|floatformat:1 }}%{% else %}-{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="text-muted">Sin ventanas evaluadas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  {% if forecast_vs_solicitud %}
  <div class="card" style="margin-top:12px;">
    <div class="card-header">Pronóstico vs Solicitud de Ventas · {{ forecast_vs_solicitud.sucursal_nombre }}</div>
    <p class="muted mb-2">
      Rango: {{ forecast_vs_solicitud.target_start }} a {{ forecast_vs_solicitud.target_end }} ·
      Escenario comparado: {{ forecast_compare_escenario|upper }} ·
      Forecast total: {{ forecast_vs_solicitud.totals.forecast_total|floatformat:2 }} ·
      Solicitud total: {{ forecast_vs_solicitud.totals.solicitud_total|floatformat:2 }} ·
      Delta: {{ forecast_vs_solicitud.totals.delta_total|floatformat:2 }}
    </p>
    <div class="toolbar mb-2">
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_vs_solicitud_export' %}?format=csv&escenario={{ forecast_compare_escenario }}&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar comparativo CSV</a>
      <a
        class="btn btn-secondary"
        href="{% url 'recetas:forecast_vs_solicitud_export' %}?format=xlsx&escenario={{ forecast_compare_escenario }}&periodo={{ periodo_pronostico_default }}{% if plan_actual %}&plan_id={{ plan_actual.id }}{% endif %}"
      >Exportar comparativo XLSX</a>
    </div>
    <form class="form-grid-auto mb-2" method="get" action="{% url 'recetas:plan_produccion' %}">
      {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
      <input type="hidden" name="periodo" value="{{ periodo_pronostico_default }}">
      <div class="form-group">
        <label class="form-label">Escenario para comparar/aplicar</label>
        <select class="form-select" name="forecast_compare_escenario">
          <option value="base" {% if forecast_compare_escenario == "base" %}selected{% endif %}>Base</option>
          <option value="bajo" {% if forecast_compare_escenario == "bajo" %}selected{% endif %}>Bajo</option>
          <option value="alto" {% if forecast_compare_escenario == "alto" %}selected{% endif %}>Alto</option>
        </select>
      </div>
      <div class="form-group" style="align-self:end;">
        <button class="btn btn-secondary" type="submit">Aplicar escenario</button>
      </div>
    </form>
    <div class="kpi-mini">
      <div class="kpi-card">
        <div class="kpi-number is-success">{{ forecast_vs_solicitud.totals.ok_count }}</div>
        <div class="kpi-label">Alineadas</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number is-danger">{{ forecast_vs_solicitud.totals.sobre_count }}</div>
        <div class="kpi-label">Sobre-solicitud</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number is-danger">{{ forecast_vs_solicitud.totals.bajo_count }}</div>
        <div class="kpi-label">Bajo-solicitud</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number">{{ forecast_vs_solicitud.totals.sin_base_count }}</div>
        <div class="kpi-label">Sin base histórica</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number is-success">{{ forecast_vs_solicitud.totals.en_rango_count }}</div>
        <div class="kpi-label">En rango</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number is-danger">{{ forecast_vs_solicitud.totals.sobre_rango_count }}</div>
        <div class="kpi-label">Sobre rango</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-number is-danger">{{ forecast_vs_solicitud.totals.bajo_rango_count }}</div>
        <div class="kpi-label">Bajo rango</div>
      </div>
    </div>
    {% if forecast_vs_solicitud.sucursal_id %}
    <div class="toolbar mt-2">
      <form method="post" action="{% url 'recetas:solicitud_ventas_aplicar_desde_forecast' %}" class="inline-form">
        {% csrf_token %}
        {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
        <input type="hidden" name="modo" value="desviadas">
        <input type="hidden" name="escenario" value="{{ forecast_compare_escenario }}">
        <input class="form-control" type="number" step="0.1" min="0" name="max_variacion_pct" placeholder="Tope % (opc)" style="max-width:130px;">
        <button class="btn btn-secondary" type="submit">Ajustar desviadas (sobre+bajo)</button>
      </form>
      <form method="post" action="{% url 'recetas:solicitud_ventas_aplicar_desde_forecast' %}" class="inline-form">
        {% csrf_token %}
        {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
        <input type="hidden" name="modo" value="sobre">
        <input type="hidden" name="escenario" value="{{ forecast_compare_escenario }}">
        <input class="form-control" type="number" step="0.1" min="0" name="max_variacion_pct" placeholder="Tope % (opc)" style="max-width:130px;">
        <button class="btn btn-secondary" type="submit">Ajustar solo sobre-solicitud</button>
      </form>
      <form method="post" action="{% url 'recetas:solicitud_ventas_aplicar_desde_forecast' %}" class="inline-form">
        {% csrf_token %}
        {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
        <input type="hidden" name="modo" value="bajo">
        <input type="hidden" name="escenario" value="{{ forecast_compare_escenario }}">
        <input class="form-control" type="number" step="0.1" min="0" name="max_variacion_pct" placeholder="Tope % (opc)" style="max-width:130px;">
        <button class="btn btn-secondary" type="submit">Ajustar solo bajo-solicitud</button>
      </form>
    </div>
    {% else %}
    <div class="alert alert-info mt-2">
      Para aplicar ajustes automáticos por renglón o en lote, genera el forecast seleccionando una sucursal específica.
    </div>
    {% endif %}
    <div class="table-responsive mt-2">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Receta</th>
            <th class="text-end">Forecast</th>
            <th class="text-end">Baja</th>
            <th class="text-end">Alta</th>
            <th class="text-end">Solicitud</th>
            <th class="text-end">Delta</th>
            <th class="text-end">% variación</th>
            <th>Estatus</th>
            <th>Rango</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for row in forecast_vs_solicitud.rows %}
          <tr>
            <td>{{ row.receta }}</td>
            <td class="text-end">{{ row.forecast_qty|floatformat:2 }}</td>
            <td class="text-end">{{ row.forecast_low|floatformat:2 }}</td>
            <td class="text-end">{{ row.forecast_high|floatformat:2 }}</td>
            <td class="text-end">{{ row.solicitud_qty|floatformat:2 }}</td>
            <td class="text-end">{{ row.delta_qty|floatformat:2 }}</td>
            <td class="text-end">
              {% if row.variacion_pct is not None %}
                {{ row.variacion_pct|floatformat:1 }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              {% if row.status == "OK" %}
                <span class="badge badge-verde">Alineada</span>
              {% elif row.status == "SOBRE" %}
                <span class="badge badge-rojo">Sobre</span>
              {% elif row.status == "BAJO" %}
                <span class="badge badge-amarillo">Bajo</span>
              {% else %}
                <span class="badge badge-amarillo">Sin base</span>
              {% endif %}
            </td>
            <td>
              {% if row.status_rango == "EN_RANGO" %}
                <span class="badge badge-verde">En rango</span>
              {% elif row.status_rango == "SOBRE_RANGO" %}
                <span class="badge badge-rojo">Sobre rango</span>
              {% elif row.status_rango == "BAJO_RANGO" %}
                <span class="badge badge-amarillo">Bajo rango</span>
              {% else %}
                <span class="badge badge-amarillo">Sin base</span>
              {% endif %}
            </td>
            <td>
              {% if forecast_vs_solicitud.sucursal_id and row.status != "OK" %}
              <form method="post" action="{% url 'recetas:solicitud_ventas_aplicar_desde_forecast' %}" class="inline-form">
                {% csrf_token %}
                {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
                <input type="hidden" name="modo" value="receta">
                <input type="hidden" name="receta_id" value="{{ row.receta_id }}">
                <input type="hidden" name="escenario" value="{{ forecast_compare_escenario }}">
                <input class="form-control" type="number" step="0.1" min="0" name="max_variacion_pct" placeholder="Tope %" style="max-width:95px;">
                <button class="btn btn-primary" type="submit">Ajustar a forecast</button>
              </form>
              {% else %}
              <span class="muted">-</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="10" class="text-muted">Sin filas para el filtro actual.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
  <hr>
  <div class="card-header" style="margin-top:8px;">Generar Plan desde Pronóstico</div>
  <form class="form-grid-auto" method="post" action="{% url 'recetas:plan_produccion_generar_desde_pronostico' %}">
    {% csrf_token %}
    <div class="form-group">
      <label class="form-label">Periodo</label>
      <input class="form-control" type="month" name="periodo" value="{{ periodo_pronostico_default }}" required>
    </div>
    <div class="form-group">
      <label class="form-label">Fecha de producción</label>
      <input class="form-control" type="date" name="fecha_produccion">
    </div>
    <div class="form-group">
      <label class="form-label">Nombre del plan</label>
      <input class="form-control" name="nombre" placeholder="Se autogenera si se deja vacío">
    </div>
    <div class="form-group">
      <label class="form-label">Alcance de recetas</label>
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="incluir_preparaciones" value="1">
        <span>Incluir preparaciones internas (además de producto final)</span>
      </label>
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Generar plan automáticamente</button>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header">MRP Consolidado por Período</div>
  <p class="muted mb-2">Calcula requerimientos agregados de insumos para todos los planes del período seleccionado.</p>
  <form class="form-grid-auto mb-2" method="get" action="{% url 'recetas:plan_produccion' %}">
    {% if plan_actual %}<input type="hidden" name="plan_id" value="{{ plan_actual.id }}">{% endif %}
    <div class="form-group">
      <label class="form-label">Período (mes)</label>
      <input class="form-control" type="month" name="mrp_periodo" value="{{ mrp_periodo }}">
    </div>
    <div class="form-group">
      <label class="form-label">Alcance</label>
      <select class="form-select" name="mrp_periodo_tipo">
        <option value="mes" {% if mrp_periodo_tipo == "mes" %}selected{% endif %}>Mes completo</option>
        <option value="q1" {% if mrp_periodo_tipo == "q1" %}selected{% endif %}>1ra quincena (1-15)</option>
        <option value="q2" {% if mrp_periodo_tipo == "q2" %}selected{% endif %}>2da quincena (16-fin)</option>
      </select>
    </div>
    <div class="form-group" style="align-self:end;">
      <button class="btn btn-primary" type="submit">Calcular período</button>
    </div>
  </form>
  <div class="toolbar mb-2">
    <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion_periodo_export' %}?mrp_periodo={{ mrp_periodo }}&mrp_periodo_tipo={{ mrp_periodo_tipo }}&format=csv">Exportar período CSV</a>
    <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion_periodo_export' %}?mrp_periodo={{ mrp_periodo }}&mrp_periodo_tipo={{ mrp_periodo_tipo }}&format=xlsx">Exportar período XLSX</a>
  </div>
  <div class="kpi-mini">
    <div class="kpi-card">
      <div class="kpi-number">{{ mrp_periodo_resumen.planes_count }}</div>
      <div class="kpi-label">Planes incluidos</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">{{ mrp_periodo_resumen.insumos_count }}</div>
      <div class="kpi-label">Insumos consolidados</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number {% if mrp_periodo_resumen.alertas_capacidad > 0 %}is-danger{% else %}is-success{% endif %}">{{ mrp_periodo_resumen.alertas_capacidad }}</div>
      <div class="kpi-label">Alertas capacidad</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number is-danger">${{ mrp_periodo_resumen.costo_total|floatformat:2 }}</div>
      <div class="kpi-label">Costo total período</div>
    </div>
  </div>
  {% if mrp_periodo_resumen.planes_count > 0 %}
  <div class="table-responsive mt-2">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Plan</th>
          <th>Fecha</th>
          <th class="text-end">Renglones</th>
        </tr>
      </thead>
      <tbody>
        {% for p in mrp_periodo_resumen.planes %}
        <tr>
          <td><a href="{% url 'recetas:plan_produccion' %}?plan_id={{ p.id }}&mrp_periodo={{ mrp_periodo }}&mrp_periodo_tipo={{ mrp_periodo_tipo }}">{{ p.nombre }}</a></td>
          <td>{{ p.fecha_produccion }}</td>
          <td class="text-end">{{ p.items_count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  {% if mrp_periodo_resumen.lineas_sin_match or mrp_periodo_resumen.lineas_sin_cantidad or mrp_periodo_resumen.lineas_sin_costo_unitario %}
  <div class="alert alert-info mt-2">
    Calidad de datos del período:
    sin match {{ mrp_periodo_resumen.lineas_sin_match }},
    sin cantidad {{ mrp_periodo_resumen.lineas_sin_cantidad }},
    sin costo {{ mrp_periodo_resumen.lineas_sin_costo_unitario }}.
  </div>
  {% endif %}
</div>

<div class="card">
  <div class="card-header">Planes recientes</div>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Plan</th>
          <th>Fecha</th>
          <th class="text-end">Renglones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for plan in planes %}
        <tr>
          <td>
            <a href="{% url 'recetas:plan_produccion' %}?plan_id={{ plan.id }}">{{ plan.nombre }}</a>
            {% if plan_actual and plan_actual.id == plan.id %}
              <span class="badge badge-verde">ACTIVO</span>
            {% endif %}
          </td>
          <td>{{ plan.fecha_produccion }}</td>
          <td class="text-end">{{ plan.items.count }}</td>
          <td>
            <form method="post" action="{% url 'recetas:plan_produccion_delete' plan.id %}" class="inline-form" onsubmit="return confirm('¿Eliminar este plan y todos sus renglones?');">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit">Eliminar</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-muted">No hay planes de producción registrados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if plan_actual %}
<div class="card">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="card-header mb-0">{{ plan_actual.nombre }}</div>
      <div class="muted">Fecha: {{ plan_actual.fecha_produccion }}{% if plan_actual.notas %} · {{ plan_actual.notas }}{% endif %}</div>
    </div>
    <div>
      <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion' %}">Limpiar selección</a>
    </div>
  </div>
  <div class="toolbar mt-2">
    <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion_export' plan_actual.id %}?format=csv">Exportar CSV</a>
    <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion_export' plan_actual.id %}?format=xlsx">Exportar XLSX</a>
    <a class="btn btn-secondary" href="{% url 'recetas:plan_produccion_export' plan_actual.id %}?format=point">Exportar Point (XLSX)</a>
    <a class="btn btn-primary" href="{% url 'recetas:plan_produccion_solicitud_print' plan_actual.id %}" target="_blank">Imprimir solicitud formal</a>
    <a class="btn btn-primary" href="{% url 'recetas:plan_produccion_solicitud_compras_print' plan_actual.id %}" target="_blank">Imprimir solicitud compras (MP)</a>
    {% if ui_access.can_manage_compras %}
    <form method="post" action="{% url 'recetas:plan_produccion_generar_solicitudes' plan_actual.id %}" class="inline-form" onsubmit="return confirm('Se generarán solicitudes de compra en borrador para materia prima de este plan. ¿Continuar?');">
      {% csrf_token %}
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="replace_prev" value="1" checked>
        <span>Reemplazar borradores previos del plan</span>
      </label>
      <label class="btn btn-secondary" style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="auto_create_oc" value="1" checked>
        <span>Crear OC borrador por proveedor</span>
      </label>
      <button class="btn btn-success" type="submit" name="next_view" value="plan">Generar solicitudes en Compras</button>
      <button class="btn btn-secondary" type="submit" name="next_view" value="compras">Generar y abrir Compras</button>
      <button class="btn btn-primary" type="submit" name="next_view" value="compras_print">Generar e imprimir solicitud compras</button>
    </form>
    {% endif %}
  </div>

  <hr>
  <form class="form-grid-auto" method="post" action="{% url 'recetas:plan_produccion_item_create' plan_actual.id %}">
    {% csrf_token %}
    <div class="form-group">
      <label class="form-label">Receta / Producto</label>
      <select class="form-select" name="receta_id" required>
        <option value="">Selecciona...</option>
        {% for r in recetas_disponibles %}
          <option value="{{ r.id }}">{{ r.nombre }} {% if r.tipo == "PRODUCTO_FINAL" %}(Producto final){% else %}(Preparación){% endif %}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Cantidad a producir</label>
      <input class="form-control" type="number" step="0.001" min="0.001" name="cantidad" value="1" required>
    </div>
    <div class="form-group">
      <label class="form-label">Notas</label>
      <input class="form-control" name="notas" placeholder="Opcional">
    </div>
    <div class="form-group">
      <button class="btn btn-primary" type="submit">Agregar al plan</button>
    </div>
  </form>
</div>

{% if explosion %}
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-number">{{ explosion.items_detalle|length }}</div>
    <div class="kpi-label">Renglones del plan</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-number">{{ explosion.insumos|length }}</div>
    <div class="kpi-label">Insumos requeridos</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-number is-danger">${{ explosion.costo_total|floatformat:2 }}</div>
    <div class="kpi-label">Costo total estimado</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-number {% if explosion.alertas_capacidad > 0 %}is-danger{% else %}is-success{% endif %}">{{ explosion.alertas_capacidad }}</div>
    <div class="kpi-label">Alertas de capacidad (stock)</div>
  </div>
</div>

{% if explosion.lineas_sin_cantidad %}
<div class="alert alert-info">
  <strong>Líneas sin cantidad:</strong> {{ explosion.lineas_sin_cantidad|length }}.
  Ajusta esas recetas para que entren al costeo.
</div>
{% endif %}
{% if explosion.lineas_sin_costo_unitario %}
<div class="alert alert-info">
  <strong>Líneas sin costo unitario:</strong> {{ explosion.lineas_sin_costo_unitario|length }}.
  Asigna costo al insumo para calcular su impacto.
</div>
{% endif %}
{% if explosion.lineas_sin_match %}
<div class="alert alert-info">
  <strong>Líneas sin match:</strong> {{ explosion.lineas_sin_match }}.
  Revisa matching en recetas para explosión completa.
</div>
{% endif %}

{% if plan_vs_pronostico %}
<div class="card">
  <div class="card-header">Plan vs Pronóstico ({{ plan_vs_pronostico.periodo }})</div>
  {% if plan_vs_pronostico.pronosticos_unavailable %}
  <div class="alert alert-info" style="margin-bottom: 12px;">
    Pronóstico no disponible temporalmente en este entorno; se muestra solo el plan actual.
  </div>
  {% endif %}
  <div class="kpi-mini">
    <div class="kpi-card">
      <div class="kpi-number">{{ plan_vs_pronostico.total_plan|floatformat:2 }}</div>
      <div class="kpi-label">Cantidad plan</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">{{ plan_vs_pronostico.total_pronostico|floatformat:2 }}</div>
      <div class="kpi-label">Cantidad pronóstico</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number {% if plan_vs_pronostico.desviaciones > 0 %}is-danger{% else %}is-success{% endif %}">{{ plan_vs_pronostico.desviaciones }}</div>
      <div class="kpi-label">Recetas con desviación</div>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Receta</th>
          <th class="text-end">Plan</th>
          <th class="text-end">Pronóstico</th>
          <th class="text-end">Delta</th>
          <th>Estatus</th>
        </tr>
      </thead>
      <tbody>
        {% for row in plan_vs_pronostico.rows %}
        <tr>
          <td>{{ row.receta }}</td>
          <td class="text-end">{{ row.cantidad_plan|floatformat:2 }}</td>
          <td class="text-end">{{ row.cantidad_pronostico|floatformat:2 }}</td>
          <td class="text-end">{{ row.delta|floatformat:2 }}</td>
          <td>
            {% if row.sin_pronostico %}
              <span class="badge badge-rojo">Sin pronóstico</span>
            {% elif row.delta == 0 %}
              <span class="badge badge-verde">Alineado</span>
            {% else %}
              <span class="badge badge-amarillo">Desviación</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-muted">Sin datos de plan/pronóstico.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header">Productos en el plan</div>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Receta</th>
          <th class="text-end">Cantidad</th>
          <th>Notas</th>
          <th class="text-end">Costo estimado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for row in explosion.items_detalle %}
        <tr>
          <td>{{ row.receta.nombre }}</td>
          <td class="text-end">{{ row.cantidad|floatformat:3 }}</td>
          <td>{{ row.notas|default:"-" }}</td>
          <td class="text-end">${{ row.costo_estimado|floatformat:2 }}</td>
          <td>
            <form method="post" action="{% url 'recetas:plan_produccion_item_delete' plan_actual.id row.id %}" class="inline-form">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit">Quitar</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-muted">Sin renglones en este plan.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card">
  <div class="card-header">Insumos requeridos (consolidado)</div>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Insumo</th>
          <th>Origen</th>
          <th>Proveedor sugerido</th>
          <th class="text-end">Cantidad requerida</th>
          <th class="text-end">Stock actual</th>
          <th class="text-end">Faltante</th>
          <th>Unidad</th>
          <th class="text-end">Costo unitario</th>
          <th class="text-end">Costo total</th>
          <th>Estatus capacidad</th>
        </tr>
      </thead>
      <tbody>
        {% for row in explosion.insumos %}
        <tr>
          <td>{{ row.nombre }}</td>
          <td>{% if row.origen == "Interno" %}<span class="badge badge-verde">Interno</span>{% else %}<span class="badge badge-amarillo">Materia prima</span>{% endif %}</td>
          <td>{{ row.proveedor_sugerido|default:"-" }}</td>
          <td class="text-end">{{ row.cantidad|floatformat:3 }}</td>
          <td class="text-end">{{ row.stock_actual|floatformat:3 }}</td>
          <td class="text-end">{{ row.faltante|floatformat:3 }}</td>
          <td>{{ row.unidad }}</td>
          <td class="text-end">${{ row.costo_unitario|floatformat:2 }}</td>
          <td class="text-end">${{ row.costo_total|floatformat:2 }}</td>
          <td>
            {% if row.alerta_capacidad %}
              <span class="badge badge-rojo">Stock insuficiente</span>
            {% else %}
              <span class="badge badge-verde">Capacidad OK</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="10" class="text-muted">No hay insumos calculados.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="8" class="text-end">Costo total plan</th>
          <th class="text-end">${{ explosion.costo_total|floatformat:2 }}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
{% endif %}
{% endif %}
</div>
{% endblock %}
