{% extends "base.html" %}
{% block title %}Matching pendientes{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Matching pendientes</h3>
  <form class="d-flex" method="get">
    <input class="form-control me-2" name="q" placeholder="Filtrar ingrediente" value="{{ q }}">
    <button class="btn btn-outline-primary" type="submit">Filtrar</button>
  </form>
</div>

<div class="alert alert-info">
  Selecciona el insumo oficial usando búsqueda en vivo (autocomplete servidor).
</div>

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>Receta</th>
        <th>Ingrediente</th>
        <th>Score</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody>
      {% for l in page.object_list %}
      <tr>
        <td><a href="{% url 'recetas:receta_detail' l.receta.id %}">{{ l.receta.nombre }}</a></td>
        <td>{{ l.insumo_texto }}</td>
        <td><span class="badge bg-warning text-dark">{{ l.match_method }} {{ l.match_score|floatformat:0 }}</span></td>
        <td>
          <form method="post" action="{% url 'recetas:aprobar_matching' l.id %}" class="d-flex gap-2 align-items-start flex-column matching-form" data-search-url="{% url 'recetas:matching_insumos_search' %}">
            {% csrf_token %}
            <input type="text" class="form-control form-control-sm insumo-filter-input" placeholder="Buscar insumo...">
            <select name="insumo_id" class="form-select form-select-sm insumo-filter-select" required>
              <option value="">Selecciona...</option>
            </select>
            <button class="btn btn-sm btn-success" type="submit">Aprobar</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="4" class="text-muted">No hay pendientes</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav>
  <ul class="pagination">
    {% if page.has_previous %}
      <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page.previous_page_number }}">Anterior</a></li>
    {% endif %}
    <li class="page-item disabled"><a class="page-link">Página {{ page.number }} de {{ page.paginator.num_pages }}</a></li>
    {% if page.has_next %}
      <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page.next_page_number }}">Siguiente</a></li>
    {% endif %}
  </ul>
</nav>

<script>
(function () {
  function debounce(fn, wait) {
    let timer = null;
    return function (...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  async function fetchOptions(searchUrl, query) {
    const url = new URL(searchUrl, window.location.origin);
    url.searchParams.set("q", query || "");
    url.searchParams.set("limit", "20");
    const resp = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
    if (!resp.ok) {
      return [];
    }
    const data = await resp.json();
    return Array.isArray(data.results) ? data.results : [];
  }

  function renderOptions(select, results) {
    const previous = select.value || "";
    select.innerHTML = '<option value="">Selecciona...</option>';
    results.forEach((item) => {
      const opt = document.createElement("option");
      opt.value = item.id;
      opt.textContent = item.nombre;
      select.appendChild(opt);
    });
    if (previous && results.some((r) => String(r.id) === String(previous))) {
      select.value = previous;
    }
  }

  document.querySelectorAll(".matching-form").forEach((form) => {
    const input = form.querySelector(".insumo-filter-input");
    const select = form.querySelector(".insumo-filter-select");
    const searchUrl = form.dataset.searchUrl;
    if (!input || !select) return;

    const runSearch = debounce(async () => {
      const query = (input.value || "").trim();
      if (query.length < 2) {
        renderOptions(select, []);
        return;
      }
      const results = await fetchOptions(searchUrl, query);
      renderOptions(select, results);
    }, 250);

    input.addEventListener("input", runSearch);
    input.addEventListener("focus", () => {
      if ((input.value || "").trim().length >= 2) {
        runSearch();
      }
    });

    input.addEventListener("keydown", async (ev) => {
      if (ev.key !== "Enter") return;
      ev.preventDefault();
      const query = (input.value || "").trim();
      if (query.length >= 2 && !select.value) {
        const results = await fetchOptions(searchUrl, query);
        renderOptions(select, results);
      }
      if (!select.value && select.options.length > 1) {
        select.selectedIndex = 1;
      }
      if (select.value) {
        form.submit();
      }
    });

    form.addEventListener("submit", (ev) => {
      if (!select.value) {
        ev.preventDefault();
        input.focus();
      }
    });

    const initialQuery = (input.value || "").trim();
    if (initialQuery.length >= 2) {
      runSearch();
    }
  });
})();
</script>
{% endblock %}
