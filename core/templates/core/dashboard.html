{% extends "base.html" %}

{% block title %}Dashboard - Pollyanas Dolce ERP{% endblock %}
{% block page_title %}Dashboard Ejecutivo{% endblock %}

{% block content %}
<section class="card dashboard-hero">
    <div>
        <div class="dashboard-hero-title">Operaci√≥n General</div>
        <div class="dashboard-hero-subtitle">Vista r√°pida de m√≥dulos y estado del sistema para la jornada.</div>
    </div>
    <div class="dashboard-hero-badges">
        <span class="badge bg-success">Inventario cr√≠tico: {{ criticos_count }}</span>
        <span class="badge bg-warning">Bajo reorden: {{ bajo_reorden_count }}</span>
        <span class="badge bg-primary">Alertas total: {{ alertas_count }}</span>
        <span class="badge {% if budget_alerts_active > 0 %}bg-danger{% else %}bg-success{% endif %}">
            Alertas presupuesto: {{ budget_alerts_active }}
        </span>
    </div>
</section>

{% if budget_semaforo_mes and budget_semaforo_quincena %}
<section class="card">
    <div class="card-header">Sem√°foro Presupuesto Compras (Periodo Actual)</div>
    <div class="kpi-mini">
        <article class="kpi-card">
            <div class="kpi-label">{{ budget_semaforo_mes.periodo_label }}</div>
            <div style="margin-top:8px;">
                <span class="badge {{ budget_semaforo_mes.estado_badge }}">{{ budget_semaforo_mes.estado_label }}</span>
            </div>
            <div class="muted" style="margin-top:10px;">
                Objetivo: ${{ budget_semaforo_mes.objetivo|floatformat:2 }}<br>
                Estimado: ${{ budget_semaforo_mes.estimado|floatformat:2 }}<br>
                Ejecutado: ${{ budget_semaforo_mes.ejecutado|floatformat:2 }}
            </div>
            <div style="margin-top:10px;">
                <a class="btn btn-secondary" href="{% url 'compras:solicitudes' %}?periodo_tipo=mes&periodo_mes={{ budget_semaforo_mes.periodo_mes }}">Ver detalle</a>
            </div>
        </article>
        <article class="kpi-card">
            <div class="kpi-label">{{ budget_semaforo_quincena.periodo_label }}</div>
            <div style="margin-top:8px;">
                <span class="badge {{ budget_semaforo_quincena.estado_badge }}">{{ budget_semaforo_quincena.estado_label }}</span>
            </div>
            <div class="muted" style="margin-top:10px;">
                Objetivo: ${{ budget_semaforo_quincena.objetivo|floatformat:2 }}<br>
                Estimado: ${{ budget_semaforo_quincena.estimado|floatformat:2 }}<br>
                Ejecutado: ${{ budget_semaforo_quincena.ejecutado|floatformat:2 }}
            </div>
            <div style="margin-top:10px;">
                <a class="btn btn-secondary" href="{% url 'compras:solicitudes' %}?periodo_tipo={{ budget_semaforo_quincena.periodo_tipo }}&periodo_mes={{ budget_semaforo_quincena.periodo_mes }}">Ver detalle</a>
            </div>
        </article>
    </div>
    {% if latest_budget_alert %}
    <div class="alert {% if budget_alerts_active > 0 %}alert-danger{% else %}alert-success{% endif %}" style="margin-top:10px;">
        √öltima alerta bit√°cora: {{ latest_budget_alert.timestamp|date:"Y-m-d H:i" }} ¬∑ {{ latest_budget_alert.object_id }}
        <a href="{% url 'audit_log' %}?model=compras.PresupuestoCompraPeriodo&action=ALERT" class="btn btn-secondary" style="margin-left: 10px;">Ver bit√°cora</a>
    </div>
    {% endif %}
</section>
{% endif %}

{% if latest_almacen_sync %}
<section class="card">
    <div class="card-header">√öltimo Sync de Almac√©n</div>
    <div class="table-responsive">
        <table class="table table-striped">
            <tbody>
                <tr>
                    <th>Estatus</th>
                    <td class="text-end">
                        {% if latest_almacen_sync.status == "OK" %}
                        <span class="badge bg-success">OK</span>
                        {% else %}
                        <span class="badge bg-danger">ERROR</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Fecha</th>
                    <td class="text-end">{{ latest_almacen_sync.started_at|date:"Y-m-d H:i" }}</td>
                </tr>
                <tr>
                    <th>Origen</th>
                    <td class="text-end">{{ latest_almacen_sync.get_source_display }}</td>
                </tr>
                <tr>
                    <th>Carpeta / Mes</th>
                    <td class="text-end">
                        {{ latest_almacen_sync.folder_name|default:"-" }}
                        {% if latest_almacen_sync.target_month %} ¬∑ {{ latest_almacen_sync.target_month }}{% endif %}
                        {% if latest_almacen_sync.fallback_used %} (fallback){% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Resultado</th>
                    <td class="text-end">
                        Existencias {{ latest_almacen_sync.existencias_updated }} ¬∑ Movimientos {{ latest_almacen_sync.movimientos_created }} ¬∑
                        Sin match {{ latest_almacen_sync.unmatched }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="quick-actions">
        <a href="{% url 'inventario:importar_archivos' %}" class="btn btn-secondary">Ver historial de sync</a>
    </div>
</section>
{% endif %}

<div class="kpi-grid">
    <article class="kpi-card">
        <div class="kpi-number">{{ insumos_count }}</div>
        <div class="kpi-label">Insumos Activos</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-success">{{ recetas_count }}</div>
        <div class="kpi-label">Recetas Activas</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-warning">{{ proveedores_count }}</div>
        <div class="kpi-label">Proveedores Vigentes</div>
    </article>
    <article class="kpi-card">
        <div class="kpi-number is-danger">{{ alertas_count }}</div>
        <div class="kpi-label">Alertas de Stock</div>
    </article>
</div>

<section class="card">
    <div class="card-header">Control de Homologaci√≥n y Matching</div>
    <div class="kpi-grid kpi-mini">
        <article class="kpi-card">
            <div class="kpi-number {% if homologacion_total_pending > 0 %}is-danger{% else %}is-success{% endif %}">
                {{ homologacion_total_pending }}
            </div>
            <div class="kpi-label">Pendientes totales</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if point_pending_total > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ point_pending_total }}
            </div>
            <div class="kpi-label">Pendientes Point</div>
            <div class="muted" style="margin-top:6px;">
                Insumos {{ point_pending_insumos }} ¬∑ Productos {{ point_pending_productos }} ¬∑ Proveedores {{ point_pending_proveedores }}
            </div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if recetas_pending_matching_count > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ recetas_pending_matching_count }}
            </div>
            <div class="kpi-label">L√≠neas recetas por revisar</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number {% if inventario_last_unmatched_count > 0 %}is-warning{% else %}is-success{% endif %}">
                {{ inventario_last_unmatched_count }}
            </div>
            <div class="kpi-label">Sin match √∫ltimo sync almac√©n</div>
        </article>
    </div>
    <div class="quick-actions" style="margin-top: 10px;">
        <a href="{% url 'maestros:point_pending_review' %}" class="btn btn-secondary">Pendientes Point</a>
        <a href="{% url 'recetas:matching_pendientes' %}" class="btn btn-secondary">Matching Recetas</a>
        <a href="{% url 'inventario:aliases_catalog' %}" class="btn btn-secondary">Aliases Inventario</a>
    </div>
</section>

<section class="card">
    <div class="card-header">Indicadores de Inventario (Control de Almac√©n)</div>
    <div class="kpi-grid">
        <article class="kpi-card">
            <div class="kpi-number">{{ inventario_total_count }}</div>
            <div class="kpi-label">Insumos con existencia</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number is-danger">{{ stock_bajo_min_count }}</div>
            <div class="kpi-label">Abajo de stock m√≠nimo</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number is-warning">{{ stock_sobre_max_count }}</div>
            <div class="kpi-label">Arriba de stock m√°ximo</div>
        </article>
        <article class="kpi-card">
            <div class="kpi-number is-danger">{{ lead_time_risk_count }}</div>
            <div class="kpi-label">Riesgo por lead time</div>
        </article>
    </div>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Indicador</th>
                    <th class="text-end">Valor</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Stock m√≠nimo configurado</td>
                    <td class="text-end">{{ stock_min_config_count }} / {{ inventario_total_count }}</td>
                </tr>
                <tr>
                    <td>Stock m√°ximo configurado</td>
                    <td class="text-end">{{ stock_max_config_count }} / {{ inventario_total_count }}</td>
                </tr>
                <tr>
                    <td>Inventario promedio configurado</td>
                    <td class="text-end">{{ inv_prom_config_count }} / {{ inventario_total_count }}</td>
                </tr>
                <tr>
                    <td>Punto de reorden configurado</td>
                    <td class="text-end">{{ punto_reorden_config_count }} / {{ inventario_total_count }}</td>
                </tr>
                <tr>
                    <td>D√≠as promedio de llegada de pedido</td>
                    <td class="text-end">{{ avg_dias_llegada|floatformat:1 }}</td>
                </tr>
                <tr>
                    <td>Consumo diario promedio por insumo</td>
                    <td class="text-end">{{ avg_consumo_diario|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>Consumo diario total estimado</td>
                    <td class="text-end">{{ total_consumo_diario|floatformat:2 }}</td>
                </tr>
                <tr>
                    <td>Cobertura promedio (d√≠as)</td>
                    <td class="text-end">{{ cobertura_promedio_dias|floatformat:2 }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</section>

<div class="dashboard-grid">
    <section class="card">
        <div class="card-header">Accesos Operativos</div>
        <div class="quick-actions">
            {% if can_view_maestros %}
                <a href="{% url 'maestros:insumo_list' %}" class="btn btn-secondary">üì¶ Cat√°logo de insumos</a>
                <a href="{% url 'maestros:proveedor_list' %}" class="btn btn-secondary">üè¢ Cat√°logo de proveedores</a>
            {% endif %}
            {% if can_view_compras %}
                <a href="{% url 'compras:solicitudes' %}" class="btn btn-primary">üõí Flujo de compras</a>
            {% endif %}
            {% if can_view_crm %}
                <a href="{% url 'crm:pedidos' %}" class="btn btn-secondary">ü§ù CRM pedidos</a>
            {% endif %}
            {% if can_view_logistica %}
                <a href="{% url 'logistica:rutas' %}" class="btn btn-secondary">üöö Log√≠stica entregas</a>
            {% endif %}
            {% if can_view_rrhh %}
                <a href="{% url 'rrhh:empleados' %}" class="btn btn-secondary">üë• RRHH n√≥mina</a>
            {% endif %}
            {% if can_view_inventario %}
                <a href="{% url 'inventario:existencias' %}" class="btn btn-primary">üìö Control de inventario</a>
                <a href="{% url 'inventario:importar_archivos' %}" class="btn btn-secondary">üì§ Cargar archivos almac√©n</a>
                <a href="{% url 'activos:dashboard' %}" class="btn btn-secondary">üõ†Ô∏è Activos y mantenimiento</a>
            {% endif %}
            {% if can_view_reportes %}
                <a href="{% url 'reportes:costo_receta' %}" class="btn btn-secondary">üìà Reportes ejecutivos</a>
                <a href="{% url 'control:discrepancias' %}" class="btn btn-secondary">üß≠ Control discrepancias</a>
            {% endif %}
            {% if can_view_recetas %}
                <a href="{% url 'recetas:recetas_list' %}" class="btn btn-secondary">üßÅ Recetas y costeo</a>
            {% endif %}
            {% if can_review_matching %}
                <a href="{% url 'recetas:matching_pendientes' %}" class="btn btn-secondary">üîé Revisar matching</a>
            {% endif %}
        </div>
    </section>

    <section class="card">
        <div class="card-header">Estado Fase 1</div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>M√≥dulo</th>
                        <th>Estado</th>
                        <th>Alcance sprint</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Maestros</td>
                        <td><span class="badge bg-success">Activo</span></td>
                        <td>ABM b√°sico de insumos y proveedores</td>
                    </tr>
                    <tr>
                        <td>Recetas</td>
                        <td><span class="badge bg-success">Activo</span></td>
                        <td>Listado, detalle, matching y MRP inicial</td>
                    </tr>
                    <tr>
                        <td>Compras</td>
                        <td><span class="badge bg-success">Activo</span></td>
                        <td>Solicitudes, √≥rdenes y recepciones operativas</td>
                    </tr>
                    <tr>
                        <td>Inventario</td>
                        <td><span class="badge bg-success">Activo</span></td>
                        <td>Existencias, movimientos, ajustes y alertas</td>
                    </tr>
                    <tr>
                        <td>Reportes</td>
                        <td><span class="badge bg-success">Activo</span></td>
                        <td>Costo receta, consumo y faltantes exportables</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}
