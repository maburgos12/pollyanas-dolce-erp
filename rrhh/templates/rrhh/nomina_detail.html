{% extends "base.html" %}

{% block title %}RRHH · {{ periodo.folio }}{% endblock %}
{% block page_title %}RRHH · {{ periodo.folio }}{% endblock %}

{% block content %}
<section class="module-tabs" aria-label="Submódulos RRHH">
  {% for tab in module_tabs %}
    <a href="{% url tab.url_name %}" class="module-tab {% if tab.active %}active{% endif %}">{{ tab.label }}</a>
  {% endfor %}
</section>

<section class="card">
  <div class="card-header">Resumen periodo</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <tbody>
        <tr><th>Folio</th><td>{{ periodo.folio }}</td></tr>
        <tr><th>Tipo</th><td>{{ periodo.get_tipo_periodo_display }}</td></tr>
        <tr><th>Inicio</th><td>{{ periodo.fecha_inicio|date:"Y-m-d" }}</td></tr>
        <tr><th>Fin</th><td>{{ periodo.fecha_fin|date:"Y-m-d" }}</td></tr>
        <tr><th>Estatus</th><td>{{ periodo.get_estatus_display }}</td></tr>
        <tr><th>Total bruto</th><td>${{ periodo.total_bruto|floatformat:2 }}</td></tr>
        <tr><th>Total descuentos</th><td>${{ periodo.total_descuentos|floatformat:2 }}</td></tr>
        <tr><th>Total neto</th><td>${{ periodo.total_neto|floatformat:2 }}</td></tr>
      </tbody>
    </table>
  </div>
  {% if can_manage_rrhh %}
  <div class="quick-actions" style="margin-top:10px;">
    <form method="post" action="{% url 'rrhh:nomina_status' periodo.id 'BORRADOR' %}">{% csrf_token %}<button class="btn btn-secondary" type="submit">Marcar Borrador</button></form>
    <form method="post" action="{% url 'rrhh:nomina_status' periodo.id 'CERRADA' %}">{% csrf_token %}<button class="btn btn-primary" type="submit">Cerrar Nómina</button></form>
    <form method="post" action="{% url 'rrhh:nomina_status' periodo.id 'PAGADA' %}">{% csrf_token %}<button class="btn btn-secondary" type="submit">Marcar Pagada</button></form>
  </div>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Capturar línea de nómina</div>
  {% if can_manage_rrhh %}
  <form method="post" class="filters" style="margin-bottom:0;">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_line">
    <select class="input-field" name="empleado_id" required>
      <option value="">Empleado...</option>
      {% for e in empleados %}
      <option value="{{ e.id }}">{{ e.nombre }} ({{ e.codigo }})</option>
      {% endfor %}
    </select>
    <input class="input-field" type="number" step="0.01" min="0" name="dias_trabajados" placeholder="Días trabajados">
    <input class="input-field" type="number" step="0.01" min="0" name="salario_base" placeholder="Salario base (opcional)">
    <input class="input-field" type="number" step="0.01" min="0" name="bonos" placeholder="Bonos">
    <input class="input-field" type="number" step="0.01" min="0" name="descuentos" placeholder="Descuentos">
    <input class="input-field" type="text" name="observaciones" placeholder="Observaciones">
    <button class="btn btn-primary" type="submit">Guardar línea</button>
  </form>
  {% else %}
  <p class="muted">Tu rol es de consulta. No puedes editar líneas.</p>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">Detalle de líneas</div>
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Empleado</th>
          <th class="text-end">Días</th>
          <th class="text-end">Salario base</th>
          <th class="text-end">Bonos</th>
          <th class="text-end">Percepciones</th>
          <th class="text-end">Descuentos</th>
          <th class="text-end">Neto</th>
          <th>Observaciones</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for l in lineas %}
        <tr>
          <td>{{ l.empleado.nombre }}</td>
          <td class="text-end">{{ l.dias_trabajados|floatformat:2 }}</td>
          <td class="text-end">${{ l.salario_base|floatformat:2 }}</td>
          <td class="text-end">${{ l.bonos|floatformat:2 }}</td>
          <td class="text-end">${{ l.total_percepciones|floatformat:2 }}</td>
          <td class="text-end">${{ l.descuentos|floatformat:2 }}</td>
          <td class="text-end">${{ l.neto_calculado|floatformat:2 }}</td>
          <td>{{ l.observaciones|default:"-" }}</td>
          <td>
            {% if can_manage_rrhh %}
            <form method="post" onsubmit="return confirm('¿Eliminar línea?');">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_line">
              <input type="hidden" name="line_id" value="{{ l.id }}">
              <button class="btn btn-danger" type="submit">Eliminar</button>
            </form>
            {% else %}
            -
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="9" class="muted">Sin líneas capturadas en este periodo.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
